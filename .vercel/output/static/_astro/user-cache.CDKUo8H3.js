class g{static{this.DEFAULT_CONFIG={sessionDuration:24*60*60*1e3,cookieName:"user_session",requireHTTPS:!0,sameSite:"lax"}}constructor(e={}){this.config={...g.DEFAULT_CONFIG,...e}}createSession(e,r){const t=new Date,o=new Date(t.getTime()+this.config.sessionDuration);return{username:e,loginTime:t,expiresAt:o,signature:r}}generateSessionToken(e){const r=e.loginTime.getTime(),t=e.expiresAt.getTime(),o=e.signature?this.hashSignature(e.signature):"none";return`${e.username}:${r}:${t}:${o}`}parseSessionToken(e){try{const[r,t,o,a]=e.split(":");if(!r||!t||!o)return null;const s=new Date(parseInt(t)),c=new Date(parseInt(o));return c.getTime()<Date.now()?null:{username:r,loginTime:s,expiresAt:c,signature:a!=="none"?a:void 0}}catch(r){return console.error("Error parsing session token:",r),null}}validateSession(e){const r=this.parseSessionToken(e);return r?r.expiresAt.getTime()<Date.now()?{isValid:!1,error:"Sesi√≥n expirada"}:{isValid:!0,user:r.username,expiresAt:r.expiresAt}:{isValid:!1,error:"Token de sesi√≥n inv√°lido o expirado"}}saveSessionToContext(e,r){const t=this.generateSessionToken(r);e.cookies.set(this.config.cookieName,t,{httpOnly:!0,secure:this.config.requireHTTPS,sameSite:this.config.sameSite,expires:r.expiresAt,path:"/",maxAge:Math.floor(this.config.sessionDuration/1e3)}),console.log(`‚úÖ Sesi√≥n guardada para usuario: ${r.username}`)}getSessionFromContext(e){const r=e.cookies.get(this.config.cookieName)?.value;return r?this.parseSessionToken(r):null}clearSessionFromContext(e){e.cookies.delete(this.config.cookieName,{path:"/"}),console.log("üîì Sesi√≥n eliminada")}renewSession(e){const r=new Date,t=new Date(r.getTime()+this.config.sessionDuration);return{...e,expiresAt:t}}isSessionNearExpiry(e){return e.expiresAt.getTime()-Date.now()<36e5}hashSignature(e){let r=0;for(let t=0;t<e.length;t++){const o=e.charCodeAt(t);r=(r<<5)-r+o,r=r&r}return Math.abs(r).toString(16)}getConfig(){return{...this.config}}}new g;function S(n={}){const{redirectTo:e="/",allowUnauthenticated:r=!1,requireSpecificUser:t,showError:o=!0}=n;try{if(typeof window>"u")return{isAuthenticated:!1,user:null,error:"Guard ejecutado en server-side, usar server guard"};const a=localStorage.getItem("authenticated_user");return a?t&&a!==t?{isAuthenticated:!1,user:a,error:`Acceso denegado. Se requiere usuario: ${t}`,redirectTo:e}:{isAuthenticated:!0,user:a}:r?{isAuthenticated:!1,user:null}:{isAuthenticated:!1,user:null,error:"Usuario no autenticado",redirectTo:e}}catch(a){return console.error("‚ùå Error en guard de autenticaci√≥n:",a),{isAuthenticated:!1,user:null,error:"Error validando autenticaci√≥n",redirectTo:e}}}function i(){return S({allowUnauthenticated:!0,showError:!1}).user}const l={curation_stats:10*60*1e3,delegation_stats:15*60*1e3,dashboard_data:15*60*1e3,calculate_results:5*60*1e3,payment_config:60*60*1e3,user_preferences:24*60*60*1e3};class m{constructor(){this.version="1.0.0"}generateCacheKey(e,r,t){const o=`${e}_${r}`;return t?`${o}_${t}`:o}validateUserAccess(e,r){return e===r}isExpired(e,r){return Date.now()-e.timestamp>l[r]}get(e,r){try{const t=i();if(!t)return console.warn("‚ö†Ô∏è UserCache: Usuario no autenticado, no se puede acceder al cach√©"),null;const o=this.generateCacheKey(e,t,r),a=localStorage.getItem(o);if(!a)return null;const s=JSON.parse(a);return this.validateUserAccess(s.user,t)?this.isExpired(s,e)?(console.log(`‚è∞ UserCache: Datos expirados para ${e}, limpiando...`),this.remove(e,r),null):(console.log(`‚úÖ UserCache: Datos obtenidos del cach√© para ${t}:${e}`),s.data):(console.warn("‚ö†Ô∏è UserCache: Acceso denegado a datos de usuario diferente"),this.remove(e,r),null)}catch(t){return console.error("‚ùå UserCache: Error obteniendo datos del cach√©:",t),null}}set(e,r,t){try{const o=i();if(!o)return console.warn("‚ö†Ô∏è UserCache: Usuario no autenticado, no se puede guardar en cach√©"),!1;const a=this.generateCacheKey(e,o,t),s={data:r,timestamp:Date.now(),user:o,version:this.version,ttl:l[e]};return localStorage.setItem(a,JSON.stringify(s)),console.log(`‚úÖ UserCache: Datos guardados para ${o}:${e}`),!0}catch(o){return console.error("‚ùå UserCache: Error guardando datos en cach√©:",o),!1}}remove(e,r){try{const t=i();if(!t)return!1;const o=this.generateCacheKey(e,t,r);return localStorage.removeItem(o),console.log(`üóëÔ∏è UserCache: Datos removidos para ${t}:${e}`),!0}catch(t){return console.error("‚ùå UserCache: Error removiendo datos del cach√©:",t),!1}}clearUserCache(){try{const e=i();if(!e)return;const r=[];for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);o&&o.includes(`_${e}`)&&r.push(o)}r.forEach(t=>{localStorage.removeItem(t)}),console.log(`üßπ UserCache: Cach√© limpiado para usuario ${e} (${r.length} elementos)`)}catch(e){console.error("‚ùå UserCache: Error limpiando cach√© de usuario:",e)}}clearCacheForUser(e){try{const r=[];for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);o&&o.includes(`_${e}`)&&r.push(o)}r.forEach(t=>{localStorage.removeItem(t)}),console.log(`üßπ UserCache: Cach√© limpiado para usuario espec√≠fico ${e} (${r.length} elementos)`)}catch(r){console.error("‚ùå UserCache: Error limpiando cach√© de usuario espec√≠fico:",r)}}cleanupExpiredCache(){try{let e=0;const r=[];for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);if(!o)continue;const a=Object.keys(l);if(a.some(c=>o.startsWith(c)))try{const c=localStorage.getItem(o);if(!c)continue;const h=JSON.parse(c),d=a.find(p=>o.startsWith(p));if(!d)continue;this.isExpired(h,d)&&r.push(o)}catch{r.push(o)}}return r.forEach(t=>{localStorage.removeItem(t),e++}),e>0&&console.log(`üßπ UserCache: Limpieza autom√°tica completada (${e} elementos expirados removidos)`),e}catch(e){return console.error("‚ùå UserCache: Error en limpieza autom√°tica:",e),0}}getCacheInfo(){const e=i();let r=0,t=0;const o={curation_stats:0,delegation_stats:0,dashboard_data:0,calculate_results:0,payment_config:0,user_preferences:0};try{for(let a=0;a<localStorage.length;a++){const s=localStorage.key(a);if(!s)continue;const h=Object.keys(l).find(d=>s.startsWith(d));h&&(r++,o[h]++,e&&s.includes(`_${e}`)&&t++)}return{totalItems:r,userItems:t,currentUser:e,itemsByType:o}}catch(a){return console.error("‚ùå UserCache: Error obteniendo informaci√≥n del cach√©:",a),{totalItems:0,userItems:0,currentUser:e,itemsByType:o}}}has(e,r){return this.get(e,r)!==null}getAge(e,r){try{const t=i();if(!t)return null;const o=this.generateCacheKey(e,t,r),a=localStorage.getItem(o);if(!a)return null;const s=JSON.parse(a);return Date.now()-s.timestamp}catch{return null}}}const u=new m;function f(){try{const n=i();if(!n)return;const e=[{legacy:"dashboard_curation_stats",new:u.generateCacheKey("curation_stats",n)},{legacy:"dashboard_delegation_stats",new:u.generateCacheKey("delegation_stats",n)},{legacy:"dashboard_last_update",new:u.generateCacheKey("dashboard_data",n)}];let r=0;e.forEach(({legacy:t,new:o})=>{const a=localStorage.getItem(t);if(a)try{const c={data:JSON.parse(a),timestamp:Date.now(),user:n,version:"1.0.0",ttl:l.dashboard_data};localStorage.setItem(o,JSON.stringify(c)),localStorage.removeItem(t),r++}catch(s){console.warn(`‚ö†Ô∏è Error migrando cach√© legacy ${t}:`,s),localStorage.removeItem(t)}}),r>0&&console.log(`‚úÖ UserCache: Migraci√≥n completada (${r} elementos migrados)`)}catch(n){console.error("‚ùå UserCache: Error en migraci√≥n legacy:",n)}}function y(){typeof window>"u"||(f(),setTimeout(()=>{u.cleanupExpiredCache()},1e3),console.log("‚úÖ UserCache: Sistema inicializado correctamente"))}const C=Object.freeze(Object.defineProperty({__proto__:null,UserCacheManager:m,initializeUserCache:y,migrateLegacyCache:f,userCache:u},Symbol.toStringTag,{value:"Module"}));export{C as a,S as r,u};
