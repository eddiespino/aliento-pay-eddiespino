class o{constructor(e={}){this.memoryCache=new Map,this.STORAGE_KEY="hive_avatars_cache",this.VERSION_KEY="hive_avatars_cache_version",this.CACHE_VERSION="1.0.0",this.options={maxAge:e.maxAge||60*60*1e3,maxEntries:e.maxEntries||500,preloadBatch:e.preloadBatch||20},this.initializeCache()}static getInstance(e){return o.instance||(o.instance=new o(e)),o.instance}initializeCache(){try{if(localStorage.getItem(this.VERSION_KEY)!==this.CACHE_VERSION){console.log("ðŸ”„ Avatar cache version mismatch, clearing cache"),this.clearAll(),localStorage.setItem(this.VERSION_KEY,this.CACHE_VERSION);return}const t=localStorage.getItem(this.STORAGE_KEY);if(t){const a=JSON.parse(t),r=Date.now();Object.entries(a).forEach(([s,c])=>{const i=c;r-i.timestamp<this.options.maxAge&&this.memoryCache.set(s,i)}),console.log(`ðŸ“¦ Loaded ${this.memoryCache.size} avatar entries from cache`)}}catch(e){console.warn("âš ï¸ Error initializing avatar cache:",e),this.clearAll()}}generateAvatarUrl(e){return e?`https://images.hive.blog/u/${e.replace("@","").trim().toLowerCase()}/avatar`:""}getAvatarUrl(e){if(!e)return"";const t=e.trim().toLowerCase(),a=this.memoryCache.get(t);if(a){if(Date.now()-a.timestamp<this.options.maxAge)return a.url;this.memoryCache.delete(t)}const r=this.generateAvatarUrl(t);return this.setCacheEntry(t,r,!1),r}async preloadAvatars(e){if(!e||e.length===0)return;const a=[...new Set(e.map(s=>s.trim().toLowerCase()))].filter(s=>!this.memoryCache.has(s));if(a.length===0){console.log("âœ… All avatars already cached");return}console.log(`âš¡ Preloading ${a.length} avatars...`);const r=this.chunkArray(a,this.options.preloadBatch);for(const s of r)await this.preloadBatch(s);console.log(`âœ… Preloaded ${a.length} avatars`)}async preloadBatch(e){const t=e.map(a=>this.preloadSingleAvatar(a));await Promise.allSettled(t)}async preloadSingleAvatar(e){try{const t=this.generateAvatarUrl(e),a=new Image;return a.crossOrigin="anonymous",new Promise((r,s)=>{a.onload=()=>{this.setCacheEntry(e,t,!1),r()},a.onerror=()=>{this.setCacheEntry(e,t,!0),s(new Error(`Failed to load avatar for ${e}`))},a.src=t})}catch(t){console.warn(`âš ï¸ Error preloading avatar for ${e}:`,t)}}setCacheEntry(e,t,a){const r={url:t,timestamp:Date.now(),isDefault:a};this.memoryCache.set(e,r),this.maintainCacheSize(),this.persistToStorage()}maintainCacheSize(){if(this.memoryCache.size>this.options.maxEntries){const e=Array.from(this.memoryCache.entries());e.sort((a,r)=>a[1].timestamp-r[1].timestamp);const t=e.slice(0,this.memoryCache.size-this.options.maxEntries);t.forEach(([a])=>this.memoryCache.delete(a)),console.log(`ðŸ§¹ Cleaned ${t.length} old avatar cache entries`)}}persistToStorage(){try{const e=Object.fromEntries(this.memoryCache.entries());localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("âš ï¸ Error persisting avatar cache:",e),this.clearExpiredEntries();try{const t=Object.fromEntries(this.memoryCache.entries());localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}catch(t){console.warn("âš ï¸ Retry persisting avatar cache failed:",t)}}}clearExpiredEntries(){const e=Date.now(),t=[];this.memoryCache.forEach((a,r)=>{e-a.timestamp>this.options.maxAge&&t.push(r)}),t.forEach(a=>this.memoryCache.delete(a)),t.length>0&&(console.log(`ðŸ§¹ Cleared ${t.length} expired avatar cache entries`),this.persistToStorage())}clearAll(){this.memoryCache.clear(),localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.VERSION_KEY),console.log("ðŸ§¹ Cleared all avatar cache")}getCacheStats(){const e=Array.from(this.memoryCache.values()),t=e.length>0?Math.min(...e.map(a=>a.timestamp)):null;return{size:this.memoryCache.size,maxSize:this.options.maxEntries,hitRate:0,oldestEntry:t}}chunkArray(e,t){const a=[];for(let r=0;r<e.length;r+=t)a.push(e.slice(r,r+t));return a}}const h=n=>o.getInstance(n);export{o as AvatarCacheService,h as getAvatarCache};
