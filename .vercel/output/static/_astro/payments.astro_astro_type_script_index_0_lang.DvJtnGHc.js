let E=!1,m=null,h=null,y=!1,f=[],r=[];const B=20;function d(n,e="info"){const t=document.createElement("div");t.className=`fixed top-4 right-4 z-50 w-full max-w-sm pointer-events-auto
      rounded-xl backdrop-blur-md bg-gray-900/90 ring-1 ring-white/10 text-white shadow-2xl
      flex overflow-hidden transition-transform duration-300 ease-out translate-x-4 opacity-0`,t.offsetWidth,t.classList.remove("translate-x-4","opacity-0"),t.classList.add("translate-x-0","opacity-100");const s=e==="success"?"bg-green-500":e==="error"?"bg-red-500":e==="warning"?"bg-yellow-500":"bg-blue-500";t.innerHTML=`
      <div class="${s} w-1"></div>
      <div class="flex-1 flex items-start gap-3 p-4">
        <div class="text-xl">
          ${e==="success"?"‚úÖ":e==="error"?"‚ùå":e==="warning"?"‚ö†Ô∏è":"‚ÑπÔ∏è"}
        </div>
        <div class="flex-1 text-sm leading-snug">${n.replace(/\n/g,"<br/>")}</div>
        <button class="text-white/60 hover:text-white" onclick="this.closest('div[role=alert]').remove()">‚úï</button>
      </div>`,t.setAttribute("role","alert"),document.body.appendChild(t),setTimeout(()=>{t.parentElement&&t.remove()},5e3)}function R(n){const e=[],t=[...n].reverse();for(let s=0;s<t.length;s+=B){const a=t.slice(s,s+B);e.push({index:Math.floor(s/B),payments:a,status:"pending",result:null,usernames:a.map(i=>i.to),totalAmount:a.reduce((i,o)=>i+o.amount,0).toFixed(3)})}return e}function x(){const n=document.getElementById("batch-progress");if(!n||r.length===0)return;const e=r.filter(l=>l.status==="completed").length,t=r.filter(l=>l.status==="failed").length,s=r.filter(l=>l.status==="processing").length,a=r.filter(l=>l.status==="pending").length,i=r.filter(l=>l.result?.canceled).length,o=(e+t)/r.length*100;n.innerHTML=`
      <div class="bg-gray-800 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-300">Progreso de Lotes</span>
          <span class="text-sm text-gray-400">${e+t}/${r.length} procesados</span>
        </div>
        
        <div class="w-full bg-gray-700 rounded-full h-2 mb-3">
          <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-500" 
               style="width: ${o}%"></div>
        </div>
        
        <div class="grid grid-cols-5 gap-2 text-center text-xs">
          <div class="bg-green-900/30 rounded px-2 py-1">
            <div class="text-green-400 font-bold">${e}</div>
            <div class="text-green-300">Exitosos</div>
          </div>
          <div class="bg-red-900/30 rounded px-2 py-1">
            <div class="text-red-400 font-bold">${t}</div>
            <div class="text-red-300">Fallidos</div>
          </div>
          <div class="bg-blue-900/30 rounded px-2 py-1">
            <div class="text-blue-400 font-bold">${s}</div>
            <div class="text-blue-300">Procesando</div>
          </div>
          <div class="bg-gray-600/30 rounded px-2 py-1">
            <div class="text-gray-400 font-bold">${a}</div>
            <div class="text-gray-300">Pendientes</div>
          </div>
          <div class="bg-yellow-900/30 rounded px-2 py-1">
            <div class="text-yellow-400 font-bold">${i}</div>
            <div class="text-yellow-300">Cancelados</div>
          </div>
        </div>
      </div>
    `}async function V(n){const e=r[n];if(!(!e||e.status==="completed")){e.status="processing",x();try{d(`Procesando lote ${n+1}/${r.length} (${e.payments.length} usuarios)...`,"info");const t=e.payments.map(a=>["transfer",{from:m,to:a.to,amount:`${a.amount.toFixed(3)} HIVE`,memo:a.memo||"Pago de curaci√≥n - Aliento.pay"}]);console.log(`üöÄ [BATCH ${n+1}] Enviando operaciones:`,t.slice(0,3));const s=await new Promise((a,i)=>{if(!window.hive_keychain){i(new Error("Hive Keychain no est√° disponible"));return}window.hive_keychain.requestBroadcast(m,t,"active",o=>{o.success?a(o):i(new Error(o.message||o.error||"Error desconocido"))})});s.success&&(e.status="completed",e.result=s,e.payments.forEach(a=>{a.status="success",a.transactionId=s.result?.id}),d(`‚úÖ Lote ${n+1} completado exitosamente!
üí∞ ${e.totalAmount} HIVE distribuidos entre ${e.payments.length} usuarios
üîó TX: ${s.result?.id}`,"success"),f.push({batchIndex:n,success:!0,transactionId:s.result?.id,payments:e.payments.length,amount:e.totalAmount}))}catch(t){if(console.log(`‚ÑπÔ∏è [BATCH ${n+1}] Respuesta:`,t.message),t.message&&t.message.includes("Request was canceled by the user"))return console.log(`üë§ [BATCH ${n+1}] Usuario cancel√≥ la operaci√≥n`),e.status="pending",e.result={canceled:!0},d(`Lote ${n+1} cancelado por el usuario`,"info"),y=!1,!1;console.error(`‚ùå [BATCH ${n+1}] Error real:`,t),e.status="failed",e.result={error:t.message},e.payments.forEach(s=>{s.status="error",s.error=t.message}),d(`‚ùå Error en lote ${n+1}: ${t.message}`,"error"),f.push({batchIndex:n,success:!1,error:t.message,payments:e.payments.length,amount:e.totalAmount})}return x(),b(),!0}}async function k(n=0){if(y){d("Ya hay un proceso de pagos por lotes en curso","warning");return}if(!m){d("No hay usuario autenticado","error");return}const e=window.currentPayments||[];if(e.length===0){d("No hay pagos para ejecutar","warning");return}(r.length===0||n===0)&&(r=R(e),f=[]),y=!0,d(`üöÄ Iniciando pagos por lotes desde el lote ${n+1}/${r.length}
üì¶ ${B} usuarios por lote`,"info"),x();for(let c=n;c<r.length;c++){if(!await V(c)){y=!1;return}c<r.length-1&&await new Promise(u=>setTimeout(u,1e3))}y=!1;const t=f.filter(c=>c.success).length,s=f.filter(c=>!c.success).length,a=r.filter(c=>c.result?.canceled).length,i=f.filter(c=>c.success).reduce((c,p)=>c+p.payments,0),o=f.filter(c=>c.success).reduce((c,p)=>c+parseFloat(p.amount),0);let l=`üéâ Proceso de lotes completado!
`;t>0&&(l+=`‚úÖ ${t} lotes exitosos (${i} pagos)
`,l+=`üí∞ Total enviado: ${o.toFixed(3)} HIVE
`),s>0&&(l+=`‚ùå ${s} lotes fallidos
`),a>0&&(l+=`‚èπÔ∏è ${a} lotes cancelados
`),(a>0||s>0)&&(l+='‚ÑπÔ∏è Puedes usar "Continuar lotes" para reanudar'),d(l,t>0?"success":a>0?"info":"warning")}function W(){const n=r.findIndex(e=>e.status==="pending"||e.status==="failed"||e.result?.canceled);n!==-1?(r.forEach(e=>{e.result?.canceled&&(e.status="pending",e.result=null)}),k(n)):d("No hay lotes pendientes para continuar","info")}function b(){const n=window.currentPayments||[],e=window.currentPaymentBatch||null;if(n.length===0){const u=document.getElementById("payment-summary");u&&u.classList.add("hidden");return}const t=document.getElementById("payment-summary");t&&t.classList.remove("hidden");const s=document.getElementById("total-payments");s&&(s.textContent=n.length.toString());const a=document.getElementById("total-amount");if(a){const u=n.reduce((g,w)=>g+w.amount,0);a.textContent=`${u.toFixed(3)} HIVE`}const i=document.getElementById("connected-user");i&&(i.textContent=m||"No conectado");const o=!!m,l=document.getElementById("execute-all-payments");l&&(l.disabled=!o);const c=document.getElementById("execute-batch-payments");c&&(c.disabled=!o);const p=document.getElementById("continue-batch-payments");if(p){const u=r.some(g=>g.status==="pending"||g.status==="failed"||g.result?.canceled);p.disabled=!o||!u}if(e&&e.groups){const{high:u,medium:g,low:w}=e.groups,P=document.getElementById("high-group-count");P&&(P.textContent=u.count.toString());const I=document.getElementById("high-group-amount");I&&(I.textContent=u.totalAmount+" HIVE");const L=document.getElementById("medium-group-count");L&&(L.textContent=g.count.toString());const A=document.getElementById("medium-group-amount");A&&(A.textContent=g.totalAmount+" HIVE");const C=document.getElementById("low-group-count");C&&(C.textContent=w.count.toString());const N=document.getElementById("low-group-amount");N&&(N.textContent=w.totalAmount+" HIVE");const H=document.getElementById("execute-high-payments");H&&(H.disabled=!o||u.count===0);const S=document.getElementById("execute-medium-payments");S&&(S.disabled=!o||g.count===0);const T=document.getElementById("execute-low-payments");T&&(T.disabled=!o||w.count===0)}}async function z(n,e="todos los pagos"){if(!m){d("No hay usuario autenticado","error");return}if(!n||n.length===0){d("No hay pagos para ejecutar","warning");return}try{d(`Iniciando ${n.length} pagos con Keychain...`,"info");const t=n.map(a=>["transfer",{from:m,to:a.to,amount:`${a.amount.toFixed(3)} HIVE`,memo:a.memo||"Pago de curaci√≥n - Aliento.pay"}]);console.log(`üí∏ [PAYMENTS] Enviando ${t.length} operaciones:`,t.slice(0,3));const s=await new Promise((a,i)=>{if(!window.hive_keychain){i(new Error("Hive Keychain no est√° disponible"));return}window.hive_keychain.requestBroadcast(m,t,"active",o=>{o.success?a(o):i(new Error(o.message||o.error||"Error desconocido"))})});if(s.success){const a=n.reduce((i,o)=>i+o.amount,0);d(`¬°√âxito! ${e} ejecutados correctamente.
üí∞ Total: ${a.toFixed(3)} HIVE
üîó TX ID: ${s.result?.id}`,"success"),n.forEach(i=>{i.status="success"}),b()}}catch(t){console.log("‚ÑπÔ∏è [PAYMENTS] Respuesta:",t.message),t&&t.message&&t.message.includes("Request was canceled by the user")?(console.log("üë§ [PAYMENTS] Usuario cancel√≥ la operaci√≥n"),d("Operaci√≥n cancelada por el usuario","info")):(console.error("‚ùå [PAYMENTS] Error real:",t),d(`Error ejecutando ${e}: ${t.message}`,"error"))}}function M(){E=!E,b()}window.executeGroupPayments=function(n){const e=window.currentPaymentBatch;if(!e)return;const t=e.groups[n];if(!t||t.count===0)return;const s={high:"pagos de alto valor",medium:"pagos de valor medio",low:"pagos de bajo valor"};z(t.payments,s[n]||"pagos del grupo")};function U(){if(console.log("üîÑ Inicializando sistema de pagos..."),m=localStorage.getItem("authenticated_user"),!m){d("No hay usuario autenticado. Redirigiendo...","warning"),setTimeout(()=>window.location.href="/",2e3);return}E=window.isGroupView||!1,b(),E&&window.currentPaymentBatch&&M(),F(),G(),console.log("‚úÖ Sistema de pagos inicializado correctamente")}function F(){const n=document.getElementById("execute-all-payments");if(n){n.replaceWith(n.cloneNode(!0));const o=document.getElementById("execute-all-payments");o&&o.addEventListener("click",()=>{z(window.currentPayments,"todos los pagos")})}const e=document.getElementById("execute-batch-payments");if(e){e.replaceWith(e.cloneNode(!0));const o=document.getElementById("execute-batch-payments");o&&o.addEventListener("click",()=>{k(0)})}const t=document.getElementById("continue-batch-payments");if(t){t.replaceWith(t.cloneNode(!0));const o=document.getElementById("continue-batch-payments");o&&o.addEventListener("click",W)}const s=document.getElementById("reset-batch-payments");if(s){s.replaceWith(s.cloneNode(!0));const o=document.getElementById("reset-batch-payments");o&&o.addEventListener("click",()=>{r=[],f=[],y=!1,x(),d("Lotes reseteados","info")})}const a=document.getElementById("toggle-group-view");if(a){a.replaceWith(a.cloneNode(!0));const o=document.getElementById("toggle-group-view");o&&o.addEventListener("click",M)}const i=document.getElementById("refresh-data");if(i){i.replaceWith(i.cloneNode(!0));const o=document.getElementById("refresh-data");o&&o.addEventListener("click",()=>window.location.reload())}}function G(){const n=new URL(window.location.href);if(n.searchParams.has("data")){const e=n.searchParams.has("groups");n.searchParams.delete("data"),e||n.searchParams.delete("groups"),window.history.replaceState({},"",n.toString())}}function _(){return document.readyState==="complete"||document.readyState==="interactive"}function v(n=3,e=100){let t=0;function s(){if(document.getElementById("payment-summary")){U();return}t<n?(t++,console.log(`üîÑ Reintentando inicializaci√≥n (${t}/${n})`),setTimeout(s,e)):console.error("‚ùå No se pudo inicializar el sistema de pagos")}s()}document.addEventListener("DOMContentLoaded",()=>{console.log("üìÑ DOMContentLoaded event"),v()});window.addEventListener("load",()=>{console.log("üåê Window load event"),v()});document.addEventListener("astro:page-load",()=>{console.log("üöÄ Astro page load event"),$(),v()});document.addEventListener("astro:before-preparation",()=>{console.log("üßπ Limpiando estado antes de navegaci√≥n"),h&&h.disconnect()});function $(){h&&h.disconnect(),h=new MutationObserver(n=>{for(const e of n)if(e.type==="childList"){const t=document.getElementById("payment-summary");if(t&&!t.dataset.initialized){console.log("üîç Detectado componente payment-summary, inicializando..."),t.dataset.initialized="true",v();break}}}),h.observe(document.body,{childList:!0,subtree:!0})}document.addEventListener("aliento:page-ready",()=>{console.log("üéØ Aliento: P√°gina lista, inicializando sistema de pagos"),$(),v()});$();_()&&(console.log("‚ö° P√°gina ya lista, inicializando inmediatamente"),setTimeout(()=>v(),50));
