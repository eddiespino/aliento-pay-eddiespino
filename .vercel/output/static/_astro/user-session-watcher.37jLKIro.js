import{_ as d}from"./preload-helper.BlTxHScW.js";import{r as o,u as h}from"./user-cache.CDKUo8H3.js";class u{constructor(){this.state={isAuthenticated:!1,user:null,isLoading:!0,error:null},this.listeners=[],this.initialized=!1,this.initializeAuth()}initializeAuth(){if(typeof window>"u"){this.state.isLoading=!1,this.initialized=!0;return}try{const e=o({allowUnauthenticated:!0,showError:!1});this.state={isAuthenticated:e.isAuthenticated,user:e.user,isLoading:!1,error:e.error||null},this.initialized=!0,this.notifyListeners(),this.setupStorageListener()}catch(e){console.error("‚ùå Error inicializando AuthHook:",e),this.state={isAuthenticated:!1,user:null,isLoading:!1,error:"Error inicializando autenticaci√≥n"},this.initialized=!0,this.notifyListeners()}}setupStorageListener(){typeof window>"u"||(window.addEventListener("storage",e=>{e.key==="authenticated_user"&&this.refreshAuthState()}),window.addEventListener("auth:login",()=>{this.refreshAuthState()}),window.addEventListener("auth:logout",()=>{this.refreshAuthState()}))}refreshAuthState(){const e=o({allowUnauthenticated:!0,showError:!1}),t={isAuthenticated:e.isAuthenticated,user:e.user,isLoading:!1,error:e.error||null};this.hasStateChanged(t)&&(this.state=t,this.notifyListeners())}hasStateChanged(e){return this.state.isAuthenticated!==e.isAuthenticated||this.state.user!==e.user||this.state.error!==e.error}notifyListeners(){this.listeners.forEach(e=>{try{e(this.state)}catch(t){console.error("‚ùå Error en listener de AuthHook:",t)}})}subscribe(e){return this.listeners.push(e),this.initialized&&e(this.state),()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}getState(){return{...this.state}}refresh(){this.refreshAuthState()}notifyLogin(e){typeof window<"u"&&(localStorage.setItem("authenticated_user",e),window.dispatchEvent(new CustomEvent("auth:login",{detail:{user:e}}))),this.refreshAuthState()}notifyLogout(){typeof window<"u"&&(localStorage.removeItem("authenticated_user"),window.dispatchEvent(new CustomEvent("auth:logout"))),this.refreshAuthState()}}new u;const a={emitLogin:i=>{typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth:login",{detail:{user:i}}))},emitLogout:()=>{typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth:logout"))},onLogin:i=>{if(typeof window<"u"){const e=t=>{i(t.detail.user)};return window.addEventListener("auth:login",e),()=>{window.removeEventListener("auth:login",e)}}return()=>{}},onLogout:i=>typeof window<"u"?(window.addEventListener("auth:logout",i),()=>{window.removeEventListener("auth:logout",i)}):()=>{}};class l{constructor(){this.state={currentUser:null,isWatching:!1,lastCheck:0},this.checkInterval=null,this.CHECK_INTERVAL_MS=1e3,this.STORAGE_KEY="authenticated_user",this.performCheck=()=>{try{const{hasChanged:e,previousUser:t,currentUser:n}=this.detectUserChange();e&&this.handleUserChange(t,n),this.state.lastCheck=Date.now()}catch(e){console.error("‚ùå UserSessionWatcher: Error en verificaci√≥n:",e)}},this.handleStorageEvent=e=>{e.key===this.STORAGE_KEY&&(console.log("üëÅÔ∏è UserSessionWatcher: Cambio detectado desde otra tab"),setTimeout(this.performCheck,100))},this.handleVisibilityChange=()=>{document.hidden||(console.log("üëÅÔ∏è UserSessionWatcher: Tab visible de nuevo, verificando sesi√≥n"),setTimeout(this.performCheck,100))}}getCurrentUser(){if(typeof window>"u")return null;try{return localStorage.getItem(this.STORAGE_KEY)}catch{return null}}detectUserChange(){const e=this.getCurrentUser(),t=this.state.currentUser;return{hasChanged:e!==t,previousUser:t,currentUser:e}}async handleUserChange(e,t){if(console.log("üîÑ UserSessionWatcher: Cambio de usuario detectado",{from:e||"ninguno",to:t||"ninguno"}),e&&(console.log(`üßπ Limpiando cach√© del usuario anterior: ${e}`),h.clearCacheForUser(e),a.emitLogout()),t){console.log(`üëã Nuevo usuario logueado: ${t}`),a.emitLogin(t);try{const{migrateLegacyCache:n}=await d(async()=>{const{migrateLegacyCache:s}=await import("./user-cache.CDKUo8H3.js").then(c=>c.a);return{migrateLegacyCache:s}},[]);n()}catch(n){console.warn("‚ö†Ô∏è Error migrando cach√© legacy:",n)}}this.state.currentUser=t,this.state.lastCheck=Date.now(),this.dispatchUserChangeEvent(e,t)}dispatchUserChangeEvent(e,t){if(typeof window>"u")return;const n=new CustomEvent("user-session-change",{detail:{previousUser:e,currentUser:t,timestamp:Date.now()}});window.dispatchEvent(n)}startWatching(){if(this.state.isWatching){console.warn("‚ö†Ô∏è UserSessionWatcher: Ya est√° vigilando");return}if(typeof window>"u"){console.warn("‚ö†Ô∏è UserSessionWatcher: No disponible en server-side");return}this.state.currentUser=this.getCurrentUser(),this.state.isWatching=!0,this.state.lastCheck=Date.now(),this.checkInterval=window.setInterval(this.performCheck,this.CHECK_INTERVAL_MS),window.addEventListener("storage",this.handleStorageEvent),document.addEventListener("visibilitychange",this.handleVisibilityChange),console.log("üëÅÔ∏è UserSessionWatcher: Iniciado",{currentUser:this.state.currentUser,checkInterval:this.CHECK_INTERVAL_MS})}stopWatching(){this.state.isWatching&&(this.checkInterval!==null&&(clearInterval(this.checkInterval),this.checkInterval=null),typeof window<"u"&&(window.removeEventListener("storage",this.handleStorageEvent),document.removeEventListener("visibilitychange",this.handleVisibilityChange)),this.state.isWatching=!1,console.log("üëÅÔ∏è UserSessionWatcher: Detenido"))}forceCheck(){this.performCheck()}getState(){return{...this.state}}isWatching(){return this.state.isWatching}}const r=new l;function w(){typeof window>"u"||(r.startWatching(),window.addEventListener("beforeunload",()=>{r.stopWatching()}),console.log("‚úÖ UserSessionWatcher: Inicializado autom√°ticamente"))}function v(i){if(typeof window>"u")return()=>{};const e=t=>{const{previousUser:n,currentUser:s}=t.detail;i(n,s)};return window.addEventListener("user-session-change",e),()=>{window.removeEventListener("user-session-change",e)}}function E(i){const e=i||r.getState().currentUser;if(e&&(console.log(`üßπ Limpieza manual de cach√© para usuario: ${e}`),h.clearCacheForUser(e)),typeof window<"u")try{localStorage.removeItem("authenticated_user"),console.log("üßπ Session token removido")}catch(t){console.warn("‚ö†Ô∏è Error removiendo session token:",t)}}export{l as UserSessionWatcher,E as handleUserLogout,w as initializeUserSessionWatcher,v as onUserSessionChange,r as userSessionWatcher};
