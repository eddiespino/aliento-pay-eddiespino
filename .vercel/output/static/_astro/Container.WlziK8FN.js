import{u as d}from"./index.BYO3pZyk.js";import{HiveAccountService as u}from"./HiveAccountService.D7iZ8Fsv.js";import"./preload-helper.BlTxHScW.js";class f{constructor(){this.globalPropsCache=null,this.CACHE_DURATION=5*60*1e3,this.accountsApiUrl="https://hafsql-api.mahdiyari.info/accounts/by-names"}async getAccount(e){try{const a=await fetch(`${this.accountsApiUrl}?names=${e}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const t=await a.json();return t.length===0?null:t[0]??null}catch(a){return console.error("Error fetching Hive account:",a),null}}async getAccounts(e){try{const a=e.join(","),t=await fetch(`${this.accountsApiUrl}?names=${a}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(a){return console.error("Error fetching Hive accounts:",a),[]}}async getActiveDelegations(e){try{const a=await d(),t={"hafah-api":{accounts:{operations:{urlPath:"{accountName}/operations"}}}},o=a.extendRest(t),r=await this.getOperationsMetadata(o,e);if(r.total_operations===0)return[];let n=[];if(r.total_operations<=500){const l=await this.getDelegationsPage(o,e);n.push(...l);const s=await this.getRealTotalPages(o,e);if(s>1)for(let i=1;i<s;i++){const c=s-i;if(c<1)break;try{const h=await this.getDelegationsPage(o,e,c);n.push(...h)}catch(h){console.error(`Error en pÃ¡gina ${c}:`,h)}await new Promise(h=>setTimeout(h,150))}}else{const l=await this.getDelegationsPage(o,e);n.push(...l);const s=await this.getRealTotalPages(o,e);if(s>1)for(let i=1;i<s;i++){const c=s-i;if(c<1)break;try{const h=await this.getDelegationsPage(o,e,c);n.push(...h)}catch(h){console.error(`Error en pÃ¡gina ${c}:`,h)}await new Promise(h=>setTimeout(h,150))}}return this.processRawDelegations(n,e)}catch(a){return console.error("Error fetching delegations:",a),[]}}parseAsset(e){return typeof e=="string"?parseFloat(e.replace(/[^\d.]/g,"")):e&&typeof e=="object"&&"amount"in e&&"precision"in e?parseInt(e.amount,10)/Math.pow(10,e.precision):0}async getGlobalPropsWithCache(){const e=Date.now();if(this.globalPropsCache&&e-this.globalPropsCache.cachedAt<this.CACHE_DURATION)return this.globalPropsCache;try{const t=await(await d()).api.database_api.get_dynamic_global_properties(),o=this.parseAsset(t.total_vesting_fund_hive),r=this.parseAsset(t.total_vesting_shares),n=o/r;return this.globalPropsCache={totalVestingFundHive:t.total_vesting_fund_hive,totalVestingShares:t.total_vesting_shares,vestsToHpRatio:n,cachedAt:e},console.log(`ðŸ”„ Propiedades globales actualizadas. Ratio VESTSâ†’HP: ${n.toFixed(8)}`),this.globalPropsCache}catch(a){if(console.error("Error obteniendo propiedades globales:",a),this.globalPropsCache)return console.warn("âš ï¸ Usando cache expirado como fallback"),this.globalPropsCache;const t=.0005993102;return this.globalPropsCache={totalVestingFundHive:"0 HIVE",totalVestingShares:"0 VESTS",vestsToHpRatio:t,cachedAt:e},console.warn(`âš ï¸ Usando ratio fallback: ${t}`),this.globalPropsCache}}async vestsToHP(e){try{const a=await this.getGlobalPropsWithCache();return(parseFloat(e.replace(" VESTS",""))||0)*a.vestsToHpRatio}catch(a){return console.error("Error converting VESTS to HP:",a),(parseFloat(e.replace(" VESTS",""))||0)*.0005993102}}async batchVestsToHP(e){if(e.length===0)return[];try{const a=await this.getGlobalPropsWithCache();return e.map(t=>{let o=0;if(typeof t=="string")o=parseFloat(t.replace(" VESTS",""))||0;else if(typeof t=="number")o=t;else if(t&&typeof t=="object"&&t.amount)o=parseFloat(t.amount.toString().replace(" VESTS",""))||0;else{const r=String(t||"0");o=parseFloat(r.replace(" VESTS",""))||0}return o*a.vestsToHpRatio})}catch(a){console.error("Error en conversiÃ³n por lotes VESTS to HP:",a);const t=.0005993102;return e.map(o=>{let r=0;if(typeof o=="string")r=parseFloat(o.replace(" VESTS",""))||0;else if(typeof o=="number")r=o;else if(o&&typeof o=="object"&&o.amount)r=parseFloat(o.amount.toString().replace(" VESTS",""))||0;else{const n=String(o||"0");r=parseFloat(n.replace(" VESTS",""))||0}return r*t})}}async getOperationsMetadata(e,a){const t={accountName:a,"operation-types":"40","page-size":400,"data-size-limit":2e5},o=await e.restApi["hafah-api"].accounts.operations(t);return{total_operations:o.total_operations,total_pages:o.total_pages}}async getRealTotalPages(e,a){const t={accountName:a,"operation-types":"40","page-size":400,"data-size-limit":2e5};return(await e.restApi["hafah-api"].accounts.operations(t)).total_pages}async getDelegationsPage(e,a,t){const o={accountName:a,"operation-types":"40",page:t,"page-size":400,"data-size-limit":2e5};return(await e.restApi["hafah-api"].accounts.operations(o)).operations_result||[]}async processRawDelegations(e,a){const t=new Map;e.forEach(s=>{const{delegator:i,delegatee:c,vesting_shares:h}=s.op.value,p=t.get(i);(!p||new Date(s.timestamp)>new Date(p.timestamp))&&t.set(i,s)});const o=Array.from(t.values()).filter(s=>s.op.value.delegatee===a);if(o.length===0)return[];const r=o.map(s=>s.op.value.vesting_shares);console.log("ðŸ” Tipos de VESTS recibidos:",r.slice(0,3).map(s=>({value:s,type:typeof s,constructor:s?.constructor?.name})));const n=await this.batchVestsToHP(r);return o.map((s,i)=>{const{delegator:c,delegatee:h,vesting_shares:p}=s.op.value;return{delegator:c,delegatee:h,hpAmount:n[i]||0,vestsAmount:p,timestamp:new Date(s.timestamp),blockNumber:s.block_num,transactionId:s.trx_id}}).filter(s=>s.hpAmount>0).sort((s,i)=>i.hpAmount-s.hpAmount)}}class y{constructor(){this.storageKey="authenticated_user"}isKeychainAvailable(){return typeof window<"u"&&!!window.hive_keychain}async signMessage(e,a){return new Promise((t,o)=>{if(!this.isKeychainAvailable()){o(new Error("Hive Keychain no estÃ¡ instalado"));return}window.hive_keychain.requestSignBuffer(e,a,"Posting",n=>{n.success?t(n.result):o(new Error(n.message||"Error en la firma"))})})}getCurrentUser(){return typeof window>"u"?null:localStorage.getItem(this.storageKey)}saveSession(e){typeof window<"u"&&localStorage.setItem(this.storageKey,e)}clearSession(){typeof window<"u"&&localStorage.removeItem(this.storageKey)}}class w{constructor(e,a){this.hiveRepository=e,this.authPort=a}async login(e){const a=u.normalizeUsername(e);if(!u.isValidUsername(a))throw new Error("El nombre de usuario no es vÃ¡lido");if(!await this.hiveRepository.getAccount(a))throw new Error("La cuenta no existe en Hive");const o=`Aliento Pay Login - ${Date.now()}`;try{await this.authPort.signMessage(a,o)}catch(r){throw new Error("Error al firmar con Keychain: "+r.message)}this.authPort.saveSession(a)}logout(){this.authPort.clearSession()}getCurrentUser(){return this.authPort.getCurrentUser()}isAuthenticated(){return this.getCurrentUser()!==null}}class P{constructor(e){this.hiveRepository=e}async getDelegationsWithDelegatorInfo(e){const a=u.normalizeUsername(e);if(!u.isValidUsername(a))throw new Error("Nombre de usuario invÃ¡lido");const t=await this.hiveRepository.getActiveDelegations(a);if(t.length===0)return[];const o=t.map(l=>l.delegator),r=await this.hiveRepository.getAccounts(o),n=new Map;return r.forEach(l=>{const s=u.toUserProfile(l);s.success&&n.set(l.name,s.data)}),t.map(l=>({...l,delegatorProfile:n.get(l.delegator)||null,formattedHP:u.formatHP(l.hpAmount),formattedDate:this.formatDate(l.timestamp)}))}async getTotalDelegatedHP(e){const a=u.normalizeUsername(e);return(await this.hiveRepository.getActiveDelegations(a)).reduce((o,r)=>o+r.hpAmount,0)}async getDelegationStats(e){const a=u.normalizeUsername(e),t=await this.hiveRepository.getActiveDelegations(a),o=t.reduce((i,c)=>i+c.hpAmount,0),r=t.length,n=r>0?o/r:0;let l=null,s=null;return t.length>0&&(l=t.reduce((i,c)=>c.hpAmount>i.hpAmount?c:i),s=t.reduce((i,c)=>c.hpAmount<i.hpAmount?c:i)),{totalHP:o,delegatorsCount:r,averageHP:n,largestDelegation:l,smallestDelegation:s,formattedTotalHP:u.formatHP(o),formattedAverageHP:u.formatHP(n)}}async getDelegationsAboveThreshold(e,a){const t=u.normalizeUsername(e);return(await this.hiveRepository.getActiveDelegations(t)).filter(r=>r.hpAmount>=a)}formatDate(e){return e.toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"})}}class g{constructor(){this.hiveRepository=new f,this.authPort=new y,this.authenticationUseCase=new w(this.hiveRepository,this.authPort),this.delegationsUseCase=new P(this.hiveRepository)}static getInstance(){return g.instance||(g.instance=new g),g.instance}getAuthenticationUseCase(){return this.authenticationUseCase}getDelegationsUseCase(){return this.delegationsUseCase}getHiveRepository(){return this.hiveRepository}getAuthPort(){return this.authPort}}const E=g.getInstance();export{g as Container,E as container};
