import{_ as q}from"./preload-helper.BlTxHScW.js";(function(){window.filterState||(window.filterState={timePeriod:30,minimumHP:50,excludedUsers:[],applied:!1,curationPeriod:"30d",curationValue:0});let v=!1,w=null;function f(t,e){console.log(`üîÑ Estableciendo bot√≥n activo: ${t} = ${e}`),document.querySelectorAll(`[data-filter-type="${t}"]`).forEach(n=>{const s=n;if(s.dataset.filterState="inactive",t==="curation-period"){s.classList.remove("bg-green-500","bg-blue-500"),s.classList.add("bg-gray-700");const r=s.querySelector(".curation-radio");r&&(r.classList.remove("bg-white","bg-blue-400"),r.classList.add("border-2","border-gray-500"))}});const i=document.querySelector(`[data-filter-type="${t}"][data-filter-value="${e}"]`);if(i){if(i.dataset.filterState="active",console.log(`‚úÖ Bot√≥n activado: ${i.id}`),t==="curation-period"){i.classList.remove("bg-gray-700"),e==="24h"?i.classList.add("bg-green-500"):e==="7d"?i.classList.add("bg-blue-500"):e==="30d"&&i.classList.add("bg-gray-600");const n=i.querySelector(".curation-radio");n&&(n.classList.remove("border-2","border-gray-500"),n.classList.add("bg-white"))}}else console.warn(`‚ö†Ô∏è No se encontr√≥ bot√≥n para ${t} = ${e}`)}function x(t){!t||window.filterState.excludedUsers.includes(t)||(window.filterState.excludedUsers.push(t),p())}function I(t){const e=window.filterState.excludedUsers.indexOf(t);e>-1&&(window.filterState.excludedUsers.splice(e,1),p())}function P(){console.log("üîÑ Inicializando per√≠odo de curaci√≥n por defecto..."),!window.filterState.curationPeriod||window.filterState.curationPeriod==="30d"?(console.log("üìã Estableciendo per√≠odo por defecto: 30d"),window.filterState.curationPeriod="30d",f("curation-period","30d"),setTimeout(()=>{const t=document.getElementById("curation-btn-30d");if(t&&t.dataset.value){const e=parseFloat(t.dataset.value);window.filterState.curationValue=e,console.log(`‚úÖ Valor inicial establecido: ${e} HP para 30d`)}},100)):(console.log(`üìã Usando per√≠odo guardado: ${window.filterState.curationPeriod}`),f("curation-period",window.filterState.curationPeriod))}function h(t,e){window.filterState.curationPeriod=t,window.filterState.curationValue=e,f("curation-period",t);const a=document.querySelector(`[data-filter-type="curation-period"][data-filter-value="${t}"]`);if(a&&a.dataset.value!=="0"){const i=parseFloat(a.dataset.value||"0");window.filterState.curationValue=i,console.log("üéØ Per√≠odo de curaci√≥n seleccionado:",{period:t,value:i})}else console.log("üéØ Per√≠odo de curaci√≥n seleccionado:",{period:t,value:e})}function L(){["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(e=>{const a=document.getElementById(e);if(a){const i=a.querySelector(".curation-value");i&&(i.innerHTML=`
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm">Cargando...</span>
                  </span>
                `)}})}async function F(t=2e4,e=1e3){return L(),new Promise((a,i)=>{const n=Date.now();let s=null;const r=async()=>{const l=Date.now()-n;if(l>=t){console.warn("‚è∞ Timeout esperando datos de curaci√≥n, intentando API directa");try{const o=await fetch("/api/curation-stats");if(o.ok){const c=await o.json();console.log("‚úÖ Datos obtenidos directamente de API:",c),a(c);return}}catch(o){console.error("‚ùå Error en API directa:",o)}a({curation24h:0,curation7d:0,curation30d:0,source:"timeout"});return}if(typeof window.getCurationStatsData=="function"){const o=window.getCurationStatsData();console.log(`üîç Verificando datos (${Math.round(l/1e3)}s):`,{data:o,hasFunction:typeof window.getCurationStatsData=="function",authenticated:o.authenticated,source:o.source,hasRealData:o.curation24h>0||o.curation7d>0||o.curation30d>0});const c=JSON.stringify(o),d=s!==c;s=c;const u=o.curation24h>0||o.curation7d>0||o.curation30d>0,m=o.source&&o.source!=="auth_error",g=o.source==="server"&&o.authenticated,k=o.source==="cache"&&o.authenticated;if(u||g||k||m&&d){console.log("‚úÖ Datos de curaci√≥n disponibles:",o),a(o);return}if(l>1e4&&o.authenticated&&o.source){console.log("‚úÖ Datos v√°lidos despu√©s de 10s (pueden ser 0):",o),a(o);return}}else if(console.log("‚ö†Ô∏è Funci√≥n getCurationStatsData no disponible a√∫n"),l>5e3){console.log("üîÑ Intentando API directa por falta de funci√≥n...");try{const o=await fetch("/api/curation-stats");if(o.ok){const c=await o.json();console.log("‚úÖ Datos obtenidos directamente de API:",c),a(c);return}}catch(o){console.error("‚ùå Error en API directa:",o)}}setTimeout(r,e)};r()})}async function C(){console.log("üì° Cargando datos directamente de la API...");try{const t=await fetch("/api/curation-stats");if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const e=await t.json();return console.log("‚úÖ Datos cargados desde API:",e),e}catch(t){throw console.error("‚ùå Error cargando desde API:",t),t}}async function B(){console.log("üîç Filters: Intentando cargar datos de curaci√≥n...");try{const t=await F();console.log("üìä Filters: Datos de curaci√≥n obtenidos:",t),["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(s=>{const r=document.getElementById(s);if(!r){console.warn(`‚ö†Ô∏è Filters: Bot√≥n ${s} no encontrado`);return}const l=r.dataset.period,o=r.querySelector(".curation-value");if(o){let c=0;switch(l){case"24h":c=t.curation24h||0;break;case"7d":c=t.curation7d||0;break;case"30d":c=t.curation30d||0;break}r.dataset.value=c.toString(),o.textContent=`${c.toFixed(4)} HP`,console.log(`‚úÖ Filters: Actualizado ${s} con valor ${c.toFixed(4)} HP`)}else console.warn(`‚ö†Ô∏è Filters: Elemento .curation-value no encontrado en ${s}`)});let a=window.filterState.curationPeriod;(!a||a==="30d")&&(a="30d",console.log("üìã Usando per√≠odo por defecto: 30d"));const i=document.querySelector(`[data-filter-type="curation-period"][data-filter-value="${a}"]`);if(i){f("curation-period",a);const s=parseFloat(i.dataset.value||"0"),r=i.dataset.period||a;window.filterState.curationValue=s,window.filterState.curationPeriod=r,console.log(`‚úÖ Filters: Valor activo establecido: ${window.filterState.curationValue} HP para per√≠odo ${r}`),h(r,s)}else{console.warn(`‚ö†Ô∏è Filters: No se encontr√≥ bot√≥n para per√≠odo ${a}`);const s=document.querySelector('[data-filter-type="curation-period"][data-filter-state="active"]');if(s){const r=parseFloat(s.dataset.value||"0"),l=s.dataset.period;window.filterState.curationValue=r,window.filterState.curationPeriod=l,console.log(`‚úÖ Fallback: Usando per√≠odo activo ${l} con valor ${r}`)}}const n=new CustomEvent("curation-data-loaded",{detail:t});document.dispatchEvent(n)}catch(t){console.error("‚ùå Error cargando datos de curaci√≥n:",t),["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(a=>{const i=document.getElementById(a);if(i){i.dataset.value="0";const n=i.querySelector(".curation-value");n&&(n.textContent="0.0000 HP")}})}}async function b(t=3,e=1e3){let a=0;const i=async()=>{console.log(`üîÑ Filters: Intento ${a+1}/${t} de cargar datos de curaci√≥n`);try{await B();const n=document.querySelector('[data-filter-state="active"]');if(n&&n.dataset.value&&parseFloat(n.dataset.value)>0){console.log("‚úÖ Datos de curaci√≥n cargados exitosamente");return}console.log("‚ö†Ô∏è No hay datos reales, intentando API directa...");const s=await C();if(s&&(["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(l=>{const o=document.getElementById(l);if(o){const c=o.dataset.period,d=o.querySelector(".curation-value");if(d){let u=0;switch(c){case"24h":u=s.curation24h||0;break;case"7d":u=s.curation7d||0;break;case"30d":u=s.curation30d||0;break}o.dataset.value=u.toString(),d.textContent=`${u.toFixed(4)} HP`,console.log(`‚úÖ API: ${l} actualizado: ${u.toFixed(4)} HP`)}}}),window.filterState)){const l=document.querySelector('[data-filter-state="active"]');if(l){const o=l.dataset.period,c=parseFloat(l.dataset.value||"0");window.filterState.curationPeriod=o,window.filterState.curationValue=c,console.log(`‚úÖ Estado global actualizado desde API: ${o} = ${c} HP`)}}console.log("‚úÖ Datos de curaci√≥n cargados exitosamente")}catch(n){console.error(`‚ùå Error en intento ${a+1}:`,n),a++,a<t?(console.log(`‚è≥ Esperando ${e}ms antes del siguiente intento...`),setTimeout(i,e)):(console.error("‚ùå No se pudo cargar datos de curaci√≥n despu√©s de m√∫ltiples intentos"),["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(r=>{const l=document.getElementById(r);if(l){l.dataset.value="0";const o=l.querySelector(".curation-value");o&&(o.innerHTML=`
                        <span class="text-red-400 flex items-center gap-1">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                          </svg>
                          Error
                        </span>
                      `)}}))}};await i()}function p(){const t=document.getElementById("excluded-users-list");t&&(t.innerHTML="",window.filterState.excludedUsers.forEach(e=>{const a=document.createElement("div");a.className="flex items-center justify-between bg-[#232329] border border-[#2a2a32] rounded-lg px-3 py-2",a.innerHTML=`
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-white text-sm">@${e}</span>
        </div>
        <button 
          onclick="removeExcludedUser('${e}')"
          class="text-red-400 hover:text-red-300 transition-colors"
          title="Remover usuario"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      `,t.appendChild(a)}))}function y(t){const e=document.querySelectorAll(".filter-btn"),a=document.querySelectorAll("input"),i=document.querySelectorAll(".curation-period-btn");e.forEach(n=>{const s=n;s.disabled=t,t?n.classList.add("opacity-50","cursor-not-allowed"):n.classList.remove("opacity-50","cursor-not-allowed")}),a.forEach(n=>{const s=n;s.disabled=t,t?n.classList.add("opacity-50","cursor-not-allowed"):n.classList.remove("opacity-50","cursor-not-allowed")}),i.forEach(n=>{const s=n;s.disabled=t,t?(n.classList.add("opacity-50","cursor-not-allowed"),n.classList.remove("hover:bg-[#2a2a32]","hover:bg-emerald-700")):(n.classList.remove("opacity-50","cursor-not-allowed"),n.classList.contains("selected")?n.classList.add("hover:bg-emerald-700"):n.classList.add("hover:bg-[#2a2a32]"))})}function $(){console.log("üîÑ applyFilters() ejecut√°ndose..."),console.log("üìä Estado actual del filtro:",window.filterState);const t=document.getElementById("apply-filters-btn"),e=document.getElementById("next-btn");if(console.log("üîç Elementos encontrados:",{button:!!t,nextButton:!!e,applied:window.filterState?.applied}),window.filterState?.applied)console.log("üîÑ Editando filtros..."),console.log("Editing filters"),y(!1),window.filterState.applied=!1,t&&(t.innerHTML=`
               <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                 <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
               </svg>
               Apply Filters
             `),e&&(e.classList.add("hidden"),e.style.display="none");else{console.log("‚úÖ Aplicando filtros..."),y(!0),window.filterState.applied=!0,z(),t&&(t.innerHTML=`
               <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                 <path fill-rule="evenodd" d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" clip-rule="evenodd"></path>
               </svg>
               Edit Filters
             `),e?(console.log("üëÅÔ∏è Mostrando bot√≥n Next..."),e.classList.remove("hidden"),e.style.display="block"):console.error("‚ùå No se encontr√≥ el bot√≥n Next");const a=new CustomEvent("filtersApplied",{detail:window.filterState});document.dispatchEvent(a),console.log("‚úÖ Filtros aplicados exitosamente")}}async function D(){console.log("Going to next step with filters (including curation period):",window.filterState);const t=document.getElementById("next-btn");t&&(t.disabled=!0,t.innerHTML=`
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
          `);try{if(typeof window.getCurationStatsData=="function"){const e=window.getCurationStatsData();if(console.log("üìä Datos de curaci√≥n obtenidos del Dashboard:",e),!window.filterState.curationValue||window.filterState.curationValue===0){switch(window.filterState.curationPeriod){case"24h":window.filterState.curationValue=e.curation24h;break;case"7d":window.filterState.curationValue=e.curation7d;break;case"30d":default:window.filterState.curationValue=e.curation30d;break}console.log("‚úÖ curationValue actualizado desde Dashboard:",window.filterState.curationValue)}}else console.warn("‚ö†Ô∏è No hay datos de curaci√≥n disponibles del Dashboard")}catch(e){console.warn("‚ö†Ô∏è Error obteniendo datos de curaci√≥n del Dashboard:",e)}try{const{saveFiltersToSessionStorage:e,encodeFiltersForUrl:a}=await q(async()=>{const{saveFiltersToSessionStorage:s,encodeFiltersForUrl:r}=await import("./filter-validation.BSdVJkC0.js");return{saveFiltersToSessionStorage:s,encodeFiltersForUrl:r}},[]);e(window.filterState),localStorage.setItem("applied_filters",JSON.stringify(window.filterState)),console.log("üì¶ Filtros guardados en sessionStorage:",window.filterState),sessionStorage.setItem("calculate_loading","true"),sessionStorage.setItem("calculate_source","dashboard");const i=new CustomEvent("nextStep",{detail:window.filterState});document.dispatchEvent(i);const n=a(window.filterState);window.requestIdleCallback?window.requestIdleCallback(()=>{window.location.href=`/calculate?filters=${n}&source=dashboard`}):setTimeout(()=>{window.location.href=`/calculate?filters=${n}&source=dashboard`},0)}catch(e){console.error("‚ùå Error guardando filtros:",e),t&&(t.disabled=!1,t.innerHTML=`
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
              Next
            `),sessionStorage.setItem("applied_filters",JSON.stringify(window.filterState)),sessionStorage.setItem("calculate_loading","true");const a=encodeURIComponent(JSON.stringify(window.filterState));window.location.href=`/calculate?filters=${a}&source=dashboard`}}async function S(){if(v){console.log("‚ö†Ô∏è Filters ya inicializados, saltando...");return}return w?(console.log("‚è≥ Esperando inicializaci√≥n en progreso..."),w):(console.log("üîß Inicializando filters component..."),w=(async()=>{try{await V(),await E(),P(),console.log("üìä Iniciando carga de datos de curaci√≥n..."),await b(),setTimeout(async()=>{const t=document.querySelector('[data-filter-type="curation-period"][data-filter-state="active"]');if(t){const e=parseFloat(t.dataset.value||"0");console.log(`üîç Verificaci√≥n final: valor activo = ${e}`),e===0&&(console.log("‚ö†Ô∏è Valor a√∫n es 0, intentando una carga adicional..."),await b(2,2e3))}},2e3),v=!0,console.log("‚úÖ Filters inicializados correctamente")}catch(t){console.error("‚ùå Error inicializando filters:",t)}finally{w=null}})(),w)}async function V(){document.querySelectorAll(".filter-btn").forEach(r=>{r.addEventListener("click",function(){const o=this.closest("[data-filter-group]")?.dataset.filterGroup,c=parseInt(this.dataset.value);if(o==="time-period")window.filterState.timePeriod=c,f("time-period",c);else if(o==="minimum-hp"){window.filterState.minimumHP=c,f("minimum-hp",c);const d=document.getElementById("custom-hp-input");d&&(d.value=c.toString())}})});const t=document.getElementById("custom-hp-input");t&&t.addEventListener("input",function(){const r=parseInt(this.value)||50;window.filterState.minimumHP=r,[50,100,500,1e3].includes(r)?f("minimum-hp",r):document.querySelectorAll('[data-filter-group="minimum-hp"] .filter-btn').forEach(c=>{c.classList.remove("active","bg-sky-600","hover:bg-sky-700","text-white","font-semibold"),c.classList.add("bg-[#232329]","hover:bg-[#2a2a32]","text-gray-300","border","border-[#232329]")})});const e=document.getElementById("excluded-username-input");e&&e.addEventListener("keypress",function(r){if(r.key==="Enter"){const l=this.value.trim().replace("@","");l&&(x(l),this.value="")}});const a=document.getElementById("apply-filters-btn");a&&a.addEventListener("click",$);const i=document.getElementById("next-btn");i&&i.addEventListener("click",D),["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(r=>{const l=document.getElementById(r);l&&l.addEventListener("click",function(){const o=this.dataset.period,c=parseFloat(this.dataset.value||"0");o&&h(o,c)})});const s=E();b(),window.addEventListener("curation-stats-updated",function(r){if(console.log("üîÑ Filters: Evento de actualizaci√≥n de estad√≠sticas recibido"),r.detail){const l=r.detail;console.log("üìä Filters: Actualizando con datos del evento:",l),["curation-btn-24h","curation-btn-7d","curation-btn-30d"].forEach(c=>{const d=document.getElementById(c);if(!d)return;const u=d.dataset.period,m=d.querySelector(".curation-value");if(m){let g=0;switch(u){case"24h":g=l.curation24h||0;break;case"7d":g=l.curation7d||0;break;case"30d":g=l.curation30d||0;break}d.dataset.value=g.toString(),m.textContent=`${g.toFixed(4)} HP`,console.log(`‚úÖ Filters: Actualizado ${c} desde evento con valor ${g.toFixed(4)} HP`)}})}}),s||p()}function z(){const t={...window.filterState,timestamp:new Date().toISOString(),version:"1.0"};localStorage.setItem("aliento_filter_config",JSON.stringify(t)),console.log("üíæ Configuraci√≥n de filtros guardada:",t)}function E(){try{const t=localStorage.getItem("aliento_filter_config");if(t){const e=JSON.parse(t);console.log("üìÇ Configuraci√≥n de filtros cargada:",e),window.filterState.timePeriod=e.timePeriod||30,window.filterState.minimumHP=e.minimumHP||50,window.filterState.excludedUsers=e.excludedUsers||[],window.filterState.curationPeriod=e.curationPeriod||"30d",window.filterState.curationValue=e.curationValue||0,f("time-period",window.filterState.timePeriod.toString()),f("minimum-hp",window.filterState.minimumHP.toString());const a=document.getElementById("custom-hp-input");return a&&(a.value=window.filterState.minimumHP.toString()),h(window.filterState.curationPeriod,window.filterState.curationValue),setTimeout(()=>{const i=document.querySelector('[data-filter-type="curation-period"][data-filter-state="active"]');i?console.log("‚úÖ Bot√≥n activo despu√©s de cargar config:",{period:i.dataset.period,value:i.dataset.value,filterState:window.filterState.curationPeriod}):console.warn("‚ö†Ô∏è No se encontr√≥ bot√≥n activo despu√©s de cargar config")},100),p(),H(),!0}}catch(t){console.error("Error cargando configuraci√≥n:",t)}return!1}function H(){const t=document.querySelector(".bg-\\[\\#18181b\\]");if(t){const e=document.createElement("div");e.className="config-loaded-indicator absolute top-4 right-4 bg-green-600/20 border border-green-600/50 rounded-lg px-3 py-1 text-green-400 text-sm flex items-center gap-2",e.innerHTML=`
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Configuraci√≥n cargada
          `,t.style.position="relative",t.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.5s",setTimeout(()=>e.remove(),500)},3e3)}}function A(){document.addEventListener("astro:page-load",()=>{console.log("üîÑ Filters: Astro page load - reseteando estado"),v=!1,w=null,S()}),document.addEventListener("DOMContentLoaded",()=>{console.log("üîÑ Filters: DOM ready"),S()}),document.readyState!=="loading"&&(console.log("üîÑ Filters: DOM ya listo, inicializando inmediatamente"),setTimeout(()=>S(),50))}window.removeExcludedUser=I,window.filterState=window.filterState,A()})();
