---
import Layout from '../layouts/Layout.astro';
import Header from '../ui/components/header.astro';
import BrandCard from '../ui/base/BrandCard.astro';
import { getCurrentLocale, getTranslation } from '../i18n';

// Get current locale and translation function
const currentLocale = getCurrentLocale(Astro);
const t = (key: string) => getTranslation(currentLocale, key);

const pageTitle = t('delegate.title');
const DEFAULT_APR = 8.5;
---

<Layout title={pageTitle}>
  <!-- Translations for client-side JavaScript -->
  <script is:inline define:vars={{ translations: {
    delegate: {
      calculator: {
        title: t('delegate.calculator.title'),
        hpAmount: t('delegate.calculator.hpAmount'),
        hpPlaceholder: t('delegate.calculator.hpPlaceholder'),
        minimumHP: t('delegate.calculator.minimumHP'),
        currentAPR: t('delegate.calculator.currentAPR').replace('{apr}', DEFAULT_APR.toString()),
        estimatedEarnings: t('delegate.calculator.estimatedEarnings'),
        daily: t('delegate.calculator.daily'),
        weekly: t('delegate.calculator.weekly'),
        monthly: t('delegate.calculator.monthly'),
        yearly: t('delegate.calculator.yearly'),
        inHive: t('delegate.calculator.inHive'),
        inHbd: t('delegate.calculator.inHbd'),
        calculating: t('delegate.calculator.calculating')
      },
      preferences: {
        title: t('delegate.preferences.title'),
        description: t('delegate.preferences.description'),
        hive: {
          title: t('delegate.preferences.options.hive.title'),
          description: t('delegate.preferences.options.hive.description')
        },
        hbd: {
          title: t('delegate.preferences.options.hbd.title'),
          description: t('delegate.preferences.options.hbd.description')
        },
        hp: {
          title: t('delegate.preferences.options.hp.title'),
          description: t('delegate.preferences.options.hp.description')
        },
        donate: {
          title: t('delegate.preferences.options.donate.title'),
          description: t('delegate.preferences.options.donate.description')
        },
        selected: t('delegate.preferences.selected'),
        savePreference: t('delegate.preferences.savePreference')
      },
      delegation: {
        title: t('delegate.delegation.title'),
        currentDelegation: t('delegate.delegation.currentDelegation'),
        noDelegation: t('delegate.delegation.noDelegation'),
        delegateButton: t('delegate.delegation.delegateButton'),
        updateDelegation: t('delegate.delegation.updateDelegation'),
        connectFirst: t('delegate.delegation.connectFirst'),
        minimumRequired: t('delegate.delegation.minimumRequired')
      },
      status: {
        notConnected: t('delegate.status.notConnected'),
        connect: t('delegate.status.connect'),
        connected: t('delegate.status.connected'),
        loadingDelegation: t('delegate.status.loadingDelegation'),
        savingPreference: t('delegate.status.savingPreference'),
        delegating: t('delegate.status.delegating')
      },
      notifications: {
        preferenceSaved: t('delegate.notifications.preferenceSaved'),
        preferenceError: t('delegate.notifications.preferenceError'),
        delegationSuccess: t('delegate.notifications.delegationSuccess'),
        delegationError: t('delegate.notifications.delegationError'),
        keychainRequired: t('delegate.notifications.keychainRequired'),
        invalidAmount: t('delegate.notifications.invalidAmount'),
        loadingPreference: t('delegate.notifications.loadingPreference'),
        preferenceLoaded: t('delegate.notifications.preferenceLoaded')
      },
      info: {
        title: t('delegate.info.title'),
        steps: [
          t('delegate.info.steps.0'),
          t('delegate.info.steps.1'),
          t('delegate.info.steps.2'),
          t('delegate.info.steps.3'),
          t('delegate.info.steps.4'),
          t('delegate.info.steps.5')
        ],
        note: t('delegate.info.note')
      },
      benefits: {
        title: t('delegate.benefits.title'),
        items: [
          {
            title: t('delegate.benefits.items.0.title'),
            description: t('delegate.benefits.items.0.description')
          },
          {
            title: t('delegate.benefits.items.1.title'),
            description: t('delegate.benefits.items.1.description')
          },
          {
            title: t('delegate.benefits.items.2.title'),
            description: t('delegate.benefits.items.2.description')
          },
          {
            title: t('delegate.benefits.items.3.title'),
            description: t('delegate.benefits.items.3.description')
          }
        ]
      }
    }
  } }}>
    window.i18n = translations;
  </script>

  <div class="min-h-screen bg-[var(--bg)]">
    <Header username={null} />

    <main class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Hero Section -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-[#09b1ee] via-[#0891c7] to-[#0284c7] bg-clip-text text-transparent mb-4">
          {t('delegate.pageTitle')}
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-400 mb-6">
          {t('delegate.subtitle')}
        </p>
        <p class="text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">
          {t('delegate.description')}
        </p>
      </div>

      <!-- Connection Status -->
      <div id="connection-status" class="mb-8">
        <BrandCard>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gradient-to-br from-[#09b1ee]/20 to-[#09b1ee]/10 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-[#09b1ee]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-600 dark:text-gray-400">{t('delegate.status.notConnected')}</p>
                <p id="connected-username" class="text-lg font-bold text-[#09b1ee]">{t('delegate.status.notConnected')}</p>
              </div>
            </div>
            <button
              id="connect-keychain-btn"
              class="px-6 py-3 bg-gradient-to-r from-[#09b1ee] to-[#0891c7] hover:from-[#0891c7] hover:to-[#0284c7] text-white font-semibold rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg shadow-[#09b1ee]/20"
            >
              {t('delegate.status.connect')}
            </button>
          </div>
        </BrandCard>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Earnings Calculator -->
        <BrandCard>
          <div class="p-6">
            <h2 class="text-2xl font-bold bg-gradient-to-r from-[#09b1ee] to-[#0891c7] bg-clip-text text-transparent mb-4">
              {t('delegate.calculator.title')}
            </h2>

            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                {t('delegate.calculator.hpAmount')}
              </label>
              <div class="relative">
                <input
                  type="number"
                  id="hp-amount-input"
                  min="1"
                  step="1"
                  placeholder={t('delegate.calculator.hpPlaceholder')}
                  class="w-full px-4 py-3 bg-[var(--bg)] border-2 border-[#09b1ee]/30 rounded-xl text-[var(--fg)] placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#09b1ee] focus:border-transparent text-lg"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <span class="text-gray-500 font-medium">HP</span>
                </div>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{t('delegate.calculator.minimumHP')}</p>
            </div>

            <div class="bg-gradient-to-br from-[#09b1ee]/5 to-[#09b1ee]/10 dark:from-[#09b1ee]/10 dark:to-[#09b1ee]/20 rounded-xl p-4 mb-4">
              <p class="text-sm text-[#09b1ee] font-semibold">{t('delegate.calculator.currentAPR').replace('{apr}', DEFAULT_APR.toString())}</p>
            </div>

            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">{t('delegate.calculator.estimatedEarnings')}</h3>

            <div class="space-y-3">
              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700/50 rounded-lg border border-[#09b1ee]/20">
                <span class="text-gray-600 dark:text-gray-300">{t('delegate.calculator.daily')}</span>
                <div class="text-right">
                  <p class="text-lg font-bold text-[#09b1ee]" id="daily-hive">0.000 HIVE</p>
                  <p class="text-xs text-gray-500" id="daily-hbd">0.000 HBD</p>
                </div>
              </div>

              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700/50 rounded-lg border border-[#09b1ee]/20">
                <span class="text-gray-600 dark:text-gray-300">{t('delegate.calculator.weekly')}</span>
                <div class="text-right">
                  <p class="text-lg font-bold text-[#09b1ee]" id="weekly-hive">0.000 HIVE</p>
                  <p class="text-xs text-gray-500" id="weekly-hbd">0.000 HBD</p>
                </div>
              </div>

              <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700/50 rounded-lg border border-[#09b1ee]/20">
                <span class="text-gray-600 dark:text-gray-300">{t('delegate.calculator.monthly')}</span>
                <div class="text-right">
                  <p class="text-lg font-bold text-[#09b1ee]" id="monthly-hive">0.000 HIVE</p>
                  <p class="text-xs text-gray-500" id="monthly-hbd">0.000 HBD</p>
                </div>
              </div>

              <div class="flex items-center justify-between p-3 bg-gradient-to-br from-[#09b1ee]/10 to-[#09b1ee]/5 dark:from-[#09b1ee]/20 dark:to-[#09b1ee]/10 rounded-lg border-2 border-[#09b1ee]/30">
                <span class="text-gray-700 dark:text-gray-200 font-semibold">{t('delegate.calculator.yearly')}</span>
                <div class="text-right">
                  <p class="text-xl font-bold text-[#09b1ee]" id="yearly-hive">0.000 HIVE</p>
                  <p class="text-sm text-gray-600 dark:text-gray-400" id="yearly-hbd">0.000 HBD</p>
                </div>
              </div>
            </div>
          </div>
        </BrandCard>

        <!-- Payment Preferences -->
        <BrandCard>
          <div class="p-6">
            <h2 class="text-2xl font-bold bg-gradient-to-r from-[#09b1ee] to-[#0891c7] bg-clip-text text-transparent mb-2">
              {t('delegate.preferences.title')}
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
              {t('delegate.preferences.description')}
            </p>

            <div class="space-y-3 mb-6">
              <!-- HIVE Option -->
              <button
                data-preference="HIVE"
                class="preference-option w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-[#09b1ee]/50 transition-all duration-200 text-left group"
              >
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center">
                        <span class="text-red-500 font-bold">H</span>
                      </div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">{t('delegate.preferences.options.hive.title')}</h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{t('delegate.preferences.options.hive.description')}</p>
                  </div>
                  <div class="preference-check hidden ml-3">
                    <svg class="w-6 h-6 text-[#09b1ee]" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
              </button>

              <!-- HBD Option -->
              <button
                data-preference="HBD"
                class="preference-option w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-[#09b1ee]/50 transition-all duration-200 text-left group"
              >
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                        <span class="text-green-500 font-bold">$</span>
                      </div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">{t('delegate.preferences.options.hbd.title')}</h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{t('delegate.preferences.options.hbd.description')}</p>
                  </div>
                  <div class="preference-check hidden ml-3">
                    <svg class="w-6 h-6 text-[#09b1ee]" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
              </button>

              <!-- HP Option -->
              <button
                data-preference="HP"
                class="preference-option w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-[#09b1ee]/50 transition-all duration-200 text-left group"
              >
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <div class="w-8 h-8 rounded-full bg-[#09b1ee]/20 flex items-center justify-center">
                        <span class="text-[#09b1ee] font-bold">⚡</span>
                      </div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">{t('delegate.preferences.options.hp.title')}</h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{t('delegate.preferences.options.hp.description')}</p>
                  </div>
                  <div class="preference-check hidden ml-3">
                    <svg class="w-6 h-6 text-[#09b1ee]" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
              </button>

              <!-- DONATE Option -->
              <button
                data-preference="DONATE"
                class="preference-option w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-[#09b1ee]/50 transition-all duration-200 text-left group"
              >
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center">
                        <span class="text-purple-500 font-bold">❤️</span>
                      </div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">{t('delegate.preferences.options.donate.title')}</h3>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{t('delegate.preferences.options.donate.description')}</p>
                  </div>
                  <div class="preference-check hidden ml-3">
                    <svg class="w-6 h-6 text-[#09b1ee]" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                </div>
              </button>
            </div>

            <button
              id="save-preference-btn"
              disabled
              class="w-full px-6 py-3 bg-gradient-to-r from-[#09b1ee] to-[#0891c7] hover:from-[#0891c7] hover:to-[#0284c7] text-white font-semibold rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg shadow-[#09b1ee]/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            >
              {t('delegate.preferences.savePreference')}
            </button>
          </div>
        </BrandCard>
      </div>

      <!-- Delegation Section -->
      <BrandCard class="mb-12">
        <div class="p-6">
          <h2 class="text-2xl font-bold bg-gradient-to-r from-[#09b1ee] to-[#0891c7] bg-clip-text text-transparent mb-6">
            {t('delegate.delegation.title')}
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Current Delegation Display -->
            <div class="bg-gradient-to-br from-[#09b1ee]/5 to-[#09b1ee]/10 dark:from-[#09b1ee]/10 dark:to-[#09b1ee]/20 rounded-xl p-6 border border-[#09b1ee]/20">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{t('delegate.delegation.currentDelegation')}</p>
              <p id="current-delegation-amount" class="text-3xl font-bold text-[#09b1ee]">
                {t('delegate.status.loadingDelegation')}
              </p>
            </div>

            <!-- Delegate Button -->
            <div class="flex items-center">
              <button
                id="delegate-btn"
                disabled
                class="w-full px-6 py-4 bg-gradient-to-r from-[#09b1ee] to-[#0891c7] hover:from-[#0891c7] hover:to-[#0284c7] text-white font-bold text-lg rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg shadow-[#09b1ee]/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
              >
                {t('delegate.delegation.connectFirst')}
              </button>
            </div>
          </div>
        </div>
      </BrandCard>

      <!-- How It Works -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Steps -->
        <BrandCard>
          <div class="p-6">
            <h2 class="text-2xl font-bold bg-gradient-to-r from-[#09b1ee] to-[#0891c7] bg-clip-text text-transparent mb-6">
              {t('delegate.info.title')}
            </h2>
            <div class="space-y-4">
              {[1, 2, 3, 4, 5, 6].map(i => (
                <div class="flex gap-4">
                  <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-[#09b1ee] to-[#0891c7] rounded-full flex items-center justify-center text-white font-bold">
                    {i}
                  </div>
                  <p class="text-gray-700 dark:text-gray-300 pt-1">{t(`delegate.info.steps.${i-1}`)}</p>
                </div>
              ))}
            </div>
            <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
              <p class="text-sm text-yellow-800 dark:text-yellow-200">{t('delegate.info.note')}</p>
            </div>
          </div>
        </BrandCard>

        <!-- Benefits -->
        <BrandCard>
          <div class="p-6">
            <h2 class="text-2xl font-bold bg-gradient-to-r from-[#09b1ee] to-[#0891c7] bg-clip-text text-transparent mb-6">
              {t('delegate.benefits.title')}
            </h2>
            <div class="space-y-4">
              {[0, 1, 2, 3].map(i => (
                <div class="p-4 bg-white dark:bg-gray-700/50 rounded-lg border border-[#09b1ee]/20">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
                    {t(`delegate.benefits.items.${i}.title`)}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    {t(`delegate.benefits.items.${i}.description`)}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </BrandCard>
      </div>
    </main>
  </div>
</Layout>

<script>
  // @ts-nocheck
  // Constants
  const DEFAULT_APR = 8.5;
  const ALIENTO_PREFERENCE_ID = 'aliento_pay_preference';

  // State
  let currentUser = null;
  let selectedPreference = null;
  let hpAmount = 0;
  let currentDelegationAmount = 0;

  // Calculate earnings based on HP amount and APR
  function calculateEarnings(hpAmount, apr = DEFAULT_APR) {
    if (hpAmount < 1) {
      return {
        dailyHive: 0,
        weeklyHive: 0,
        monthlyHive: 0,
        yearlyHive: 0,
      };
    }

    const yearlyHive = (hpAmount * apr) / 100;
    const dailyHive = yearlyHive / 365;
    const weeklyHive = dailyHive * 7;
    const monthlyHive = yearlyHive / 12;

    return {
      dailyHive: Number(dailyHive.toFixed(3)),
      weeklyHive: Number(weeklyHive.toFixed(3)),
      monthlyHive: Number(monthlyHive.toFixed(3)),
      yearlyHive: Number(yearlyHive.toFixed(3)),
    };
  }

  // Notification function
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 w-full max-w-sm pointer-events-auto
      rounded-xl backdrop-blur-md bg-gray-900/90 ring-1 ring-white/10 text-white shadow-2xl
      flex overflow-hidden transition-transform duration-300 ease-out translate-x-4 opacity-0`;

    void notification.offsetWidth;
    notification.classList.remove('translate-x-4', 'opacity-0');
    notification.classList.add('translate-x-0', 'opacity-100');

    const accentColor =
      type === 'success' ? 'bg-green-500' :
      type === 'error' ? 'bg-red-500' : 'bg-blue-500';

    notification.innerHTML = `
      <div class="${accentColor} w-1"></div>
      <div class="flex-1 flex items-start gap-3 p-4">
        <div class="text-xl">
          ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}
        </div>
        <div class="flex-1 text-sm leading-snug">${message.replace(/\n/g, '<br/>')}</div>
        <button class="text-white/60 hover:text-white" onclick="this.closest('div[role=alert]').remove()">✕</button>
      </div>`;
    notification.setAttribute('role', 'alert');

    document.body.appendChild(notification);

    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // Save preference to localStorage cache
  function savePreferenceToCache(preference) {
    try {
      localStorage.setItem(
        `aliento_preference_${preference.username}`,
        JSON.stringify(preference)
      );
    } catch (error) {
      console.error('Error saving to cache:', error);
    }
  }

  // Get preference from localStorage cache
  function getPreferenceFromCache(username) {
    try {
      const cached = localStorage.getItem(`aliento_preference_${username}`);
      if (cached) {
        return JSON.parse(cached);
      }
      return null;
    } catch (error) {
      console.error('Error reading from cache:', error);
      return null;
    }
  }

  // Fetch user preference from Hive blockchain
  async function fetchPreferenceFromChain(username) {
    try {
      const response = await fetch('https://api.hive.blog', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jsonrpc: '2.0',
          method: 'account_history_api.get_account_history',
          params: {
            account: username,
            start: -1,
            limit: 100,
          },
          id: 1,
        }),
      });

      const data = await response.json();

      if (!data.result?.history) {
        return null;
      }

      // Find the most recent aliento preference custom_json
      const history = data.result.history.reverse();

      for (const [, operation] of history) {
        const [opType, opData] = operation.op;

        if (opType === 'custom_json' && opData.id === ALIENTO_PREFERENCE_ID) {
          try {
            const preference = JSON.parse(opData.json);
            return preference;
          } catch (e) {
            console.error('Error parsing preference JSON:', e);
          }
        }
      }

      return null;
    } catch (error) {
      console.error('Error fetching preference from chain:', error);
      return null;
    }
  }

  // Save preference on-chain using Hive Keychain
  function savePreferenceOnChain(username, paymentType, delegatedHP) {
    return new Promise((resolve, reject) => {
      if (!window.hive_keychain) {
        reject(new Error('Hive Keychain not available'));
        return;
      }

      const preferenceData = {
        username,
        paymentType,
        delegatedHP,
        updatedAt: new Date().toISOString(),
      };

      const jsonData = JSON.stringify(preferenceData);

      window.hive_keychain.requestCustomJson(
        username,
        ALIENTO_PREFERENCE_ID,
        'Posting',
        jsonData,
        `Save Aliento payment preference: ${paymentType}`,
        (response) => {
          if (response.success) {
            resolve(response);
          } else {
            reject(new Error(response.message || 'Failed to save preference'));
          }
        }
      );
    });
  }

  // Delegate HP to Aliento using Hive Keychain
  function delegateToAliento(from, amount) {
    return new Promise((resolve, reject) => {
      if (!window.hive_keychain) {
        reject(new Error('Hive Keychain not available'));
        return;
      }

      window.hive_keychain.requestDelegation(
        from,
        'aliento',
        amount.toFixed(3),
        'HP',
        (response) => {
          if (response.success) {
            resolve(response);
          } else {
            reject(new Error(response.message || 'Delegation failed'));
          }
        }
      );
    });
  }

  // Get current delegation to Aliento
  async function getCurrentDelegation(username) {
    try {
      const response = await fetch('https://api.hive.blog', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jsonrpc: '2.0',
          method: 'condenser_api.get_vesting_delegations',
          params: [username, 'aliento', 1],
          id: 1,
        }),
      });

      const data = await response.json();

      if (data.result && data.result.length > 0) {
        const delegation = data.result[0];
        if (delegation.delegatee === 'aliento') {
          // Convert VESTS to HP (approximate)
          const vests = parseFloat(delegation.vesting_shares);
          const hp = vests / 2000;
          return hp;
        }
      }

      return null;
    } catch (error) {
      console.error('Error fetching current delegation:', error);
      return null;
    }
  }

  // Update earnings display
  function updateEarningsDisplay() {
    const earnings = calculateEarnings(hpAmount, DEFAULT_APR);

    document.getElementById('daily-hive')!.textContent = `${earnings.dailyHive.toFixed(3)} HIVE`;
    document.getElementById('daily-hbd')!.textContent = `${earnings.dailyHive.toFixed(3)} HBD`;

    document.getElementById('weekly-hive')!.textContent = `${earnings.weeklyHive.toFixed(3)} HIVE`;
    document.getElementById('weekly-hbd')!.textContent = `${earnings.weeklyHive.toFixed(3)} HBD`;

    document.getElementById('monthly-hive')!.textContent = `${earnings.monthlyHive.toFixed(3)} HIVE`;
    document.getElementById('monthly-hbd')!.textContent = `${earnings.monthlyHive.toFixed(3)} HBD`;

    document.getElementById('yearly-hive')!.textContent = `${earnings.yearlyHive.toFixed(3)} HIVE`;
    document.getElementById('yearly-hbd')!.textContent = `${earnings.yearlyHive.toFixed(3)} HBD`;
  }

  // Update preference selection UI
  function updatePreferenceUI() {
    document.querySelectorAll('.preference-option').forEach(option => {
      const pref = option.getAttribute('data-preference');
      const checkmark = option.querySelector('.preference-check');

      if (pref === selectedPreference) {
        option.classList.add('border-[#09b1ee]', 'bg-[#09b1ee]/5');
        option.classList.remove('border-gray-200', 'dark:border-gray-700');
        checkmark?.classList.remove('hidden');
      } else {
        option.classList.remove('border-[#09b1ee]', 'bg-[#09b1ee]/5');
        option.classList.add('border-gray-200', 'dark:border-gray-700');
        checkmark?.classList.add('hidden');
      }
    });

    // Enable/disable save button
    const saveBtn = document.getElementById('save-preference-btn');
    if (saveBtn) {
      saveBtn.disabled = !currentUser || !selectedPreference;
    }
  }

  // Update delegation button
  function updateDelegationButton() {
    const delegateBtn = document.getElementById('delegate-btn');
    if (!delegateBtn) return;

    if (!currentUser) {
      delegateBtn.disabled = true;
      delegateBtn.textContent = window.i18n.delegate.delegation.connectFirst;
    } else if (hpAmount < 1) {
      delegateBtn.disabled = true;
      delegateBtn.textContent = window.i18n.delegate.delegation.minimumRequired;
    } else {
      delegateBtn.disabled = false;
      delegateBtn.textContent = window.i18n.delegate.delegation.delegateButton.replace('{amount}', hpAmount.toString());
    }
  }

  // Connect with Keychain
  async function connectKeychain() {
    if (!window.hive_keychain) {
      showNotification(window.i18n.delegate.notifications.keychainRequired, 'error');
      return;
    }

    try {
      const username = prompt('Enter your Hive username:');
      if (!username) return;

      // Verify with keychain
      window.hive_keychain.requestHandshake(() => {
        currentUser = username;
        localStorage.setItem('delegate_user', username);

        // Update UI
        document.getElementById('connected-username')!.textContent =
          window.i18n.delegate.status.connected.replace('{username}', username);

        const connectBtn = document.getElementById('connect-keychain-btn');
        if (connectBtn) {
          connectBtn.textContent = `@${username}`;
          connectBtn.classList.add('cursor-default');
        }

        // Load user data
        loadUserData();
      });
    } catch (error) {
      showNotification(`Error: ${error.message}`, 'error');
    }
  }

  // Load user data
  async function loadUserData() {
    if (!currentUser) return;

    try {
      // Load current delegation
      showNotification(window.i18n.delegate.status.loadingDelegation, 'info');
      const delegation = await getCurrentDelegation(currentUser);

      if (delegation && delegation > 0) {
        currentDelegationAmount = delegation;
        document.getElementById('current-delegation-amount')!.textContent =
          `${delegation.toFixed(3)} HP`;
      } else {
        document.getElementById('current-delegation-amount')!.textContent =
          window.i18n.delegate.delegation.noDelegation;
      }

      // Load saved preference
      showNotification(window.i18n.delegate.notifications.loadingPreference, 'info');
      const cachedPref = getPreferenceFromCache(currentUser);

      if (cachedPref) {
        selectedPreference = cachedPref.paymentType;
        updatePreferenceUI();
        showNotification(window.i18n.delegate.notifications.preferenceLoaded, 'success');
      } else {
        // Try to fetch from blockchain
        const chainPref = await fetchPreferenceFromChain(currentUser);
        if (chainPref) {
          selectedPreference = chainPref.paymentType;
          savePreferenceToCache(chainPref);
          updatePreferenceUI();
          showNotification(window.i18n.delegate.notifications.preferenceLoaded, 'success');
        }
      }
    } catch (error) {
      console.error('Error loading user data:', error);
    }

    updateDelegationButton();
  }

  // Save preference
  async function savePreference() {
    if (!currentUser || !selectedPreference) return;

    try {
      showNotification(window.i18n.delegate.status.savingPreference, 'info');

      await savePreferenceOnChain(currentUser, selectedPreference, hpAmount);

      const preference = {
        username: currentUser,
        paymentType: selectedPreference,
        delegatedHP: hpAmount,
        updatedAt: new Date().toISOString()
      };

      savePreferenceToCache(preference);

      showNotification(window.i18n.delegate.notifications.preferenceSaved, 'success');
    } catch (error) {
      showNotification(
        window.i18n.delegate.notifications.preferenceError.replace('{error}', error.message),
        'error'
      );
    }
  }

  // Delegate HP
  async function delegate() {
    if (!currentUser || hpAmount < 1) return;

    try {
      showNotification(window.i18n.delegate.status.delegating, 'info');

      await delegateToAliento(currentUser, hpAmount);

      showNotification(
        window.i18n.delegate.notifications.delegationSuccess.replace('{amount}', hpAmount.toString()),
        'success'
      );

      // Reload delegation amount
      loadUserData();
    } catch (error) {
      showNotification(
        window.i18n.delegate.notifications.delegationError.replace('{error}', error.message),
        'error'
      );
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // HP Amount input
    const hpInput = document.getElementById('hp-amount-input');
    if (hpInput) {
      hpInput.addEventListener('input', () => {
        hpAmount = parseFloat(hpInput.value) || 0;
        updateEarningsDisplay();
        updateDelegationButton();
      });
    }

    // Preference selection
    document.querySelectorAll('.preference-option').forEach(option => {
      option.addEventListener('click', () => {
        selectedPreference = option.getAttribute('data-preference');
        updatePreferenceUI();
      });
    });

    // Connect button
    document.getElementById('connect-keychain-btn')?.addEventListener('click', connectKeychain);

    // Save preference button
    document.getElementById('save-preference-btn')?.addEventListener('click', savePreference);

    // Delegate button
    document.getElementById('delegate-btn')?.addEventListener('click', delegate);

    // Check if user was previously connected
    const savedUser = localStorage.getItem('delegate_user');
    if (savedUser) {
      currentUser = savedUser;
      document.getElementById('connected-username')!.textContent =
        window.i18n.delegate.status.connected.replace('{username}', savedUser);
      const connectBtn = document.getElementById('connect-keychain-btn');
      if (connectBtn) {
        connectBtn.textContent = `@${savedUser}`;
      }
      loadUserData();
    }

    // Initial display update
    updateEarningsDisplay();
    updatePreferenceUI();
    updateDelegationButton();
  });
</script>
