---
import Layout from '../layouts/Layout.astro';
import Header from '../ui/components/header.astro';
import PaymentHero from '../ui/components/PaymentHero.astro';
import PaymentsList from '../ui/components/PaymentsList.astro';
import MemoSettings from '../ui/components/MemoSettings.astro';
import BrandCard from '../ui/base/BrandCard.astro';
import { requireAuthentication } from '../middleware';
import { protectedGetCurationStats } from '../lib/auth/protected-functions';
import type { Payment } from '../domain/models/Payment';
import { getCurrentLocale, getTranslation } from '../i18n';

// Get current locale and translation function
const currentLocale = getCurrentLocale(Astro);
const t = (key: string) => getTranslation(currentLocale, key);

const isAuthenticated = Astro.locals.isAuthenticated;
const authenticatedUser: string | null = Astro.locals.user;

// Todo el procesamiento de datos ahora ser√° del lado del cliente
// Inicializamos con arrays vac√≠os
let payments: Payment[] = [];
let error: string | null = null;

console.log('üíª [SERVER] P√°gina de pagos - procesamiento del lado del cliente');
---

---

<Layout title={t('payments.pageTitle')}>
  <!-- Translations for client-side JavaScript -->
  <script is:inline define:vars={{ translations: {
    noPayments: t('payments.noPayments'),
    goToCalculate: t('payments.goToCalculate'),
    errorTitle: t('payments.errorTitle'),
    errorInvalidData: t('payments.errorInvalidData'),
    errorNoDistributions: t('payments.errorNoDistributions'),
    paymentList: t('payments.paymentList'),
    transfers: t('payments.transfers'),
    batchProgress: {
      title: t('payments.batchProgress.title'),
      processed: t('payments.batchProgress.processed'),
      successful: t('payments.batchProgress.successful'),
      failed: t('payments.batchProgress.failed'),
      processing: t('payments.batchProgress.processing'),
      pending: t('payments.batchProgress.pending'),
      canceled: t('payments.batchProgress.canceled')
    },
    memo: {
      title: t('memo.title'),
      description: t('memo.description'),
      templateLabel: t('memo.templateLabel'),
      templatePlaceholder: t('memo.templatePlaceholder'),
      apply: t('memo.apply'),
      quickTemplates: t('memo.quickTemplates'),
      preview: t('memo.preview'),
      noPreview: t('memo.noPreview'),
      defaults: {
        basic: t('memo.defaults.basic'),
        emoji: t('memo.defaults.emoji'),
        detailed: t('memo.defaults.detailed'),
        simple: t('memo.defaults.simple')
      },
      templates: {
        default: t('memo.templates.default'),
        withEmoji: t('memo.templates.withEmoji'),
        detailed: t('memo.templates.detailed'),
        simple: t('memo.templates.simple')
      }
    }
  } }}>
    window.i18n = translations;
  </script>

  <div class="min-h-screen bg-[var(--bg)]">
    {authenticatedUser && <Header username={authenticatedUser} />}
    <main class="container mx-auto px-4 py-8">
      <PaymentHero />

      <!-- Memo Settings Component -->
      <BrandCard class="mb-8">
        <MemoSettings />
      </BrandCard>

      <!-- Contenedor din√°mico que se actualizar√° desde JavaScript -->
      <div id="payments-content">
        <div class="max-w-2xl mx-auto">
          <div
            class="bg-anakiwa-900/10 backdrop-blur-sm border border-anakiwa-500/20 rounded-xl p-8 text-center"
          >
            <div
              class="w-16 h-16 bg-anakiwa-500/20 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <svg class="w-8 h-8 text-anakiwa-400 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-anakiwa-400 mb-2">{t('payments.loadingPayments')}</h3>
            <p class="text-anakiwa-300 mb-6">{t('payments.processingData')}</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</Layout>

<!-- Script para procesar datos del lado del cliente -->
<script>
  // @ts-nocheck
  (function () {
    'use strict';

    console.log('ÔøΩ [CLIENT] Iniciando procesamiento de pagos del lado del cliente');

    // Funci√≥n para procesar datos de pagos
    function processPaymentData() {
      let paymentData = null;

      // 1. Primero intentar obtener de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const dataParam = urlParams.get('data');

      if (dataParam) {
        console.log('ÔøΩ [CLIENT] Datos encontrados en URL');
        try {
          paymentData = JSON.parse(decodeURIComponent(dataParam));
        } catch (e) {
          console.error('‚ùå [CLIENT] Error decodificando datos de URL:', e);
        }
      }

      // 2. Si no hay en URL, buscar en sessionStorage
      if (!paymentData) {
        console.log('üîç [CLIENT] Buscando en sessionStorage...');
        const stored = sessionStorage.getItem('payment_data');
        if (stored) {
          try {
            paymentData = JSON.parse(stored);
            console.log('‚úÖ [CLIENT] Datos encontrados en sessionStorage');
          } catch (e) {
            console.error('‚ùå [CLIENT] Error parsing sessionStorage:', e);
          }
        }
      }

      if (!paymentData) {
        console.log('‚ùå [CLIENT] No se encontraron datos de pago');
        showError(window.i18n.noPayments);
        return;
      }

      console.log('ÔøΩ [CLIENT] Procesando datos:', {
        hasDistributions: !!paymentData.distributions,
        distributionsCount: paymentData.distributions?.length || 0,
        totalAmount: paymentData.totalAmount,
        period: paymentData.period,
        hasMetadata: !!paymentData.calculationMetadata,
      });

      // 3. Procesar distribuciones
      if (!paymentData.distributions) {
        console.log('‚ùå [CLIENT] No hay distribuciones en los datos');
        showError(window.i18n.errorNoDistributions);
        return;
      }

      // 4. Verificar si hay payment values v√°lidos
      const hasValidPayments = paymentData.distributions.some(
        dist => dist.payment && dist.payment > 0
      );

      if (!hasValidPayments) {
        console.log('‚ùå [CLIENT] Todos los pagos son null o 0');
        showError(window.i18n.errorInvalidData);
        return;
      }

      // 5. Filtrar y crear objetos Payment
      const validDistributions = paymentData.distributions.filter(dist => {
        if (!dist.payment || dist.payment <= 0) return false;
        const rounded = Math.round(Number(dist.payment) * 1000) / 1000;
        return rounded > 0;
      });

      console.log('‚úÖ [CLIENT] Distribuciones v√°lidas:', validDistributions.length);

      // Crear pagos sin memo inicial (se generar√°n con el template)
      const payments = validDistributions.map((dist, index) => ({
        id: `payment-${index}-${Date.now()}`,
        to: dist.username,
        amount: Number(dist.payment),
        currency: 'HIVE',
        memo: '', // Se generar√° con el template
        status: 'pending',
      }));

      // 6. Hacer disponible globalmente
      window.currentPayments = payments;
      window.currentPaymentData = paymentData;
      window.currentPaymentBatch = null;
      window.isGroupView = false;

      // 7. Generar memos con el template
      payments.forEach(payment => {
        payment.memo = replaceMemoVariables(customMemoTemplate, payment, paymentData);
      });

      console.log('üí¨ [CLIENT] Pagos procesados:', {
        validPayments: payments.length,
        totalAmount: payments.reduce((sum, p) => sum + p.amount, 0).toFixed(3),
        firstPayment: payments[0] ? { to: payments[0].to, amount: payments[0].amount, memo: payments[0].memo } : null,
      });

      // 8. Mostrar la lista de pagos
      showPaymentsList(payments);
    }

    // Funci√≥n para mostrar error
    function showError(message) {
      const content = document.getElementById('payments-content');
      if (!content) return;

      content.innerHTML = `
        <div class="max-w-2xl mx-auto">
          <div class="bg-gradient-to-r from-amber-500/10 to-yellow-500/10 backdrop-blur-sm border border-amber-500/20 rounded-xl p-8 text-center">
            <div class="w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-amber-400 mb-2">${window.i18n.errorTitle}</h3>
            <p class="text-amber-300 mb-6">${message}</p>
            <a href="/calculate" class="inline-flex items-center gap-2 bg-gradient-to-r from-anakiwa-500 to-anakiwa-600 hover:from-anakiwa-600 hover:to-anakiwa-700 text-[var(--primary-contrast)] font-medium px-6 py-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              ${window.i18n.goToCalculate}
            </a>
          </div>
        </div>
      `;
    }

    // Variable global para el memo template
    let customMemoTemplate = window.i18n.memo.defaults.basic;

    // Funci√≥n para reemplazar variables en el memo
    function replaceMemoVariables(template, payment, paymentData) {
      const period = paymentData?.period || '';
      const username = payment.to || '';
      const amount = payment.amount?.toFixed(3) || '0.000';
      const date = new Date().toLocaleDateString('es-ES');

      return template
        .replace(/{period}/g, period)
        .replace(/{username}/g, username)
        .replace(/{amount}/g, amount)
        .replace(/{date}/g, date);
    }

    // Funci√≥n para actualizar todos los memos
    function updateAllMemos() {
      const payments = window.currentPayments || [];
      const paymentData = window.currentPaymentData || {};

      payments.forEach(payment => {
        payment.memo = replaceMemoVariables(customMemoTemplate, payment, paymentData);
      });

      // Refrescar la UI
      showPaymentsList(payments);
      console.log('‚úÖ Memos actualizados con template:', customMemoTemplate);
    }

    // Funci√≥n para mostrar la lista de pagos
    function showPaymentsList(payments) {
      const content = document.getElementById('payments-content');
      if (!content) return;

      // Crear el HTML de la lista de pagos
      const paymentItemsHTML = payments
        .map(
          (payment, index) => `
        <div class="bg-[var(--bg)] rounded-lg p-4 border border-[var(--border)] hover:bg-anakiwa-900/10 transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="relative w-8 h-8" data-username="${payment.to}">
                <div class="avatar-fallback w-8 h-8 bg-anakiwa-500/20 rounded-full flex items-center justify-center">
                  <span class="text-anakiwa-400 text-sm font-bold">${index + 1}</span>
                </div>
                <div class="avatar-img absolute inset-0"></div>
              </div>
              <div>
                <div class="font-medium text-[var(--fg)]">@${payment.to}</div>
                <div class="text-xs text-[var(--mutedFg)] truncate max-w-xs">${payment.memo}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-anakiwa-400">${payment.amount.toFixed(3)} HIVE</div>
              <div class="text-xs text-[var(--mutedFg)] capitalize">${payment.status}</div>
            </div>
          </div>
        </div>
      `
        )
        .join('');

      content.innerHTML = `
        <!-- Memo Customization Section -->
        <div class="bg-[var(--bgElevated)] backdrop-blur-sm border border-[var(--border)] rounded-xl p-6 mb-6">
          <div class="flex items-start gap-3 mb-4">
            <div class="w-10 h-10 bg-anakiwa-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-anakiwa-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-[var(--fg)] mb-2">${window.i18n.memo.title}</h3>
              <p class="text-sm text-[var(--mutedFg)] mb-4">
                ${window.i18n.memo.description}
                <span class="text-anakiwa-300 font-mono text-xs">{period}</span>,
                <span class="text-anakiwa-300 font-mono text-xs">{username}</span>,
                <span class="text-anakiwa-300 font-mono text-xs">{amount}</span>,
                <span class="text-anakiwa-300 font-mono text-xs">{date}</span>
              </p>

              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-[var(--mutedFg)] mb-2">${window.i18n.memo.templateLabel}</label>
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="memo-template-input"
                      value="${customMemoTemplate}"
                      class="flex-1 px-4 py-2 bg-[var(--bg)] border border-[var(--border)] rounded-lg text-[var(--fg)] placeholder-[var(--mutedFg)] focus:outline-none focus:ring-2 focus:ring-anakiwa-500 focus:border-transparent"
                      placeholder="${window.i18n.memo.templatePlaceholder}"
                    />
                    <button
                      id="update-memo-btn"
                      class="px-6 py-2 bg-gradient-to-r from-anakiwa-500 to-anakiwa-600 hover:from-anakiwa-600 hover:to-anakiwa-700 text-[var(--primary-contrast)] font-medium rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center gap-2"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                      ${window.i18n.memo.apply}
                    </button>
                  </div>
                </div>

                <!-- Templates predefinidos -->
                <div>
                  <label class="block text-sm font-medium text-[var(--mutedFg)] mb-2">${window.i18n.memo.quickTemplates}</label>
                  <div class="flex flex-wrap gap-2">
                    <button class="memo-template-btn px-3 py-1 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-colors" data-template="${window.i18n.memo.defaults.basic}">
                      ${window.i18n.memo.templates.default}
                    </button>
                    <button class="memo-template-btn px-3 py-1 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-colors" data-template="${window.i18n.memo.defaults.emoji}">
                      ${window.i18n.memo.templates.withEmoji}
                    </button>
                    <button class="memo-template-btn px-3 py-1 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-colors" data-template="${window.i18n.memo.defaults.detailed}">
                      ${window.i18n.memo.templates.detailed}
                    </button>
                    <button class="memo-template-btn px-3 py-1 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-colors" data-template="${window.i18n.memo.defaults.simple}">
                      ${window.i18n.memo.templates.simple}
                    </button>
                  </div>
                </div>

                <!-- Preview -->
                <div class="bg-anakiwa-900/10 rounded-lg p-3 border border-anakiwa-500/20">
                  <div class="text-xs text-anakiwa-300 mb-1">${window.i18n.memo.preview}</div>
                  <div class="text-sm text-[var(--fg)] font-mono" id="memo-preview">
                    ${payments.length > 0 ? payments[0].memo : window.i18n.memo.noPreview}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de Pagos -->
        <div class="bg-[var(--bgElevated)] backdrop-blur-sm border border-[var(--border)] rounded-xl p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-[var(--fg)] flex items-center gap-2">
              <svg class="w-5 h-5 text-anakiwa-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
              </svg>
              ${window.i18n.paymentList}
            </h3>
            <div class="text-sm text-[var(--mutedFg)]">
              ${payments.length} ${window.i18n.transfers}
            </div>
          </div>

          <div class="max-h-96 overflow-y-auto space-y-2">
            ${paymentItemsHTML}
          </div>
        </div>
      `;

      // Agregar event listeners despu√©s de renderizar
      setupMemoEditorListeners();
    }

    // Funci√≥n para configurar los event listeners del editor de memo
    function setupMemoEditorListeners() {
      const updateBtn = document.getElementById('update-memo-btn');
      const memoInput = document.getElementById('memo-template-input');
      const templateBtns = document.querySelectorAll('.memo-template-btn');

      if (updateBtn && memoInput) {
        updateBtn.addEventListener('click', () => {
          customMemoTemplate = memoInput.value;
          updateAllMemos();
        });

        memoInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            customMemoTemplate = memoInput.value;
            updateAllMemos();
          }
        });

        // Live preview mientras escribe
        memoInput.addEventListener('input', (e) => {
          const preview = document.getElementById('memo-preview');
          const payments = window.currentPayments || [];
          if (preview && payments.length > 0) {
            const testMemo = replaceMemoVariables(e.target.value, payments[0], window.currentPaymentData);
            preview.textContent = testMemo;
          }
        });
      }

      // Templates r√°pidos
      templateBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const template = btn.getAttribute('data-template');
          if (memoInput && template) {
            memoInput.value = template;
            customMemoTemplate = template;
            updateAllMemos();
          }
        });
      });
    }

    // Ejecutar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', processPaymentData);
    } else {
      processPaymentData();
    }
  })();
</script>

<script>
  // @ts-nocheck
  // Script principal para manejar pagos con Keychain
  let isGroupView = false;
  let currentUser = null;
  let observer = null;

  // üÜï Variables para pagos por lotes
  let batchPaymentInProgress = false;
  let currentBatchIndex = 0;
  let batchResults = [];
  let paymentBatches = [];
  const BATCH_SIZE = 20;

  // Funci√≥n para mostrar notificaciones
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 w-full max-w-sm pointer-events-auto
      rounded-xl backdrop-blur-md bg-gray-900/90 ring-1 ring-white/10 text-white shadow-2xl
      flex overflow-hidden transition-transform duration-300 ease-out translate-x-4 opacity-0`;

    // Forzar reflow para que la animaci√≥n se aplique luego a√±adir clases finales
    void notification.offsetWidth;
    notification.classList.remove('translate-x-4', 'opacity-0');
    notification.classList.add('translate-x-0', 'opacity-100');

    // Color accent bar a la izquierda
    const accentColor =
      type === 'success'
        ? 'bg-green-500'
        : type === 'error'
          ? 'bg-red-500'
          : type === 'warning'
            ? 'bg-yellow-500'
            : 'bg-blue-500';

    notification.innerHTML = `
      <div class="${accentColor} w-1"></div>
      <div class="flex-1 flex items-start gap-3 p-4">
        <div class="text-xl">
          ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
        </div>
        <div class="flex-1 text-sm leading-snug">${message.replace(/\n/g, '<br/>')}</div>
        <button class="text-white/60 hover:text-white" onclick="this.closest('div[role=alert]').remove()">‚úï</button>
      </div>`;
    notification.setAttribute('role', 'alert');

    document.body.appendChild(notification);

    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // üÜï Funci√≥n para crear lotes de pagos de 20 usuarios
  function createPaymentBatches(payments) {
    const batches = [];
    // Ordenar del final hacia el principio (como solicitas)
    const sortedPayments = [...payments].reverse();

    for (let i = 0; i < sortedPayments.length; i += BATCH_SIZE) {
      const batch = sortedPayments.slice(i, i + BATCH_SIZE);
      batches.push({
        index: Math.floor(i / BATCH_SIZE),
        payments: batch,
        status: 'pending', // pending, processing, completed, failed
        result: null,
        usernames: batch.map(p => p.to),
        totalAmount: batch.reduce((sum, p) => sum + p.amount, 0).toFixed(3),
      });
    }

    return batches;
  }

  // üÜï Funci√≥n para mostrar el progreso de lotes
  function updateBatchProgress() {
    const batchProgressEl = document.getElementById('batch-progress');
    if (!batchProgressEl || paymentBatches.length === 0) return;

    const completed = paymentBatches.filter(b => b.status === 'completed').length;
    const failed = paymentBatches.filter(b => b.status === 'failed').length;
    const processing = paymentBatches.filter(b => b.status === 'processing').length;
    const pending = paymentBatches.filter(b => b.status === 'pending').length;
    const canceled = paymentBatches.filter(b => b.result?.canceled).length;

    const progressPercent = ((completed + failed) / paymentBatches.length) * 100;

    batchProgressEl.innerHTML = `
      <div class="bg-gray-800 rounded-lg p-4 mb-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-300">${window.i18n.batchProgress.title}</span>
          <span class="text-sm text-gray-400">${completed + failed}/${paymentBatches.length} ${window.i18n.batchProgress.processed}</span>
        </div>

        <div class="w-full bg-gray-700 rounded-full h-2 mb-3">
          <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-500"
               style="width: ${progressPercent}%"></div>
        </div>

        <div class="grid grid-cols-5 gap-2 text-center text-xs">
          <div class="bg-green-900/30 rounded px-2 py-1">
            <div class="text-green-400 font-bold">${completed}</div>
            <div class="text-green-300">${window.i18n.batchProgress.successful}</div>
          </div>
          <div class="bg-red-900/30 rounded px-2 py-1">
            <div class="text-red-400 font-bold">${failed}</div>
            <div class="text-red-300">${window.i18n.batchProgress.failed}</div>
          </div>
          <div class="bg-blue-900/30 rounded px-2 py-1">
            <div class="text-blue-400 font-bold">${processing}</div>
            <div class="text-blue-300">${window.i18n.batchProgress.processing}</div>
          </div>
          <div class="bg-gray-600/30 rounded px-2 py-1">
            <div class="text-gray-400 font-bold">${pending}</div>
            <div class="text-gray-300">${window.i18n.batchProgress.pending}</div>
          </div>
          <div class="bg-yellow-900/30 rounded px-2 py-1">
            <div class="text-yellow-400 font-bold">${canceled}</div>
            <div class="text-yellow-300">${window.i18n.batchProgress.canceled}</div>
          </div>
        </div>
      </div>
    `;
  }

  // üÜï Funci√≥n para ejecutar un lote espec√≠fico de pagos
  async function executeBatchPayment(batchIndex) {
    const batch = paymentBatches[batchIndex];
    if (!batch || batch.status === 'completed') return;

    batch.status = 'processing';
    updateBatchProgress();

    try {
      showNotification(
        window.i18n.payments.notifications.batchProcessing
          .replace('{current}', (batchIndex + 1).toString())
          .replace('{total}', paymentBatches.length.toString())
          .replace('{count}', batch.payments.length.toString()),
        'info'
      );

      // Construir operaciones para requestBroadcast
      const operations = batch.payments.map(payment => [
        'transfer',
        {
          from: currentUser,
          to: payment.to,
          amount: `${payment.amount.toFixed(3)} HIVE`,
          memo: payment.memo || window.i18n.memo.defaults.basic.replace('{period}', ''),
        },
      ]);

      // Debug: mostrar las operaciones que se van a enviar
      console.log(`üöÄ [BATCH ${batchIndex + 1}] Enviando operaciones:`, operations.slice(0, 3)); // Mostrar solo las primeras 3 para no llenar la consola

      // Usar directamente requestBroadcast de Keychain
      const result = await new Promise((resolve, reject) => {
        if (!window.hive_keychain) {
          reject(new Error(window.i18n.payments.notifications.keychainNotAvailable));
          return;
        }

        window.hive_keychain.requestBroadcast(currentUser, operations, 'active', response => {
          if (response.success) {
            resolve(response);
          } else {
            reject(new Error(response.message || response.error || window.i18n.payments.notifications.unknownError));
          }
        });
      });

      if (result.success) {
        batch.status = 'completed';
        batch.result = result;

        // Marcar pagos individuales como exitosos
        batch.payments.forEach(payment => {
          payment.status = 'success';
          payment.transactionId = result.result?.id;
        });

        showNotification(
          window.i18n.payments.notifications.batchCompleted
            .replace('{index}', (batchIndex + 1).toString())
            .replace('{amount}', batch.totalAmount)
            .replace('{count}', batch.payments.length.toString())
            .replace('{txId}', result.result?.id || ''),
          'success'
        );

        batchResults.push({
          batchIndex,
          success: true,
          transactionId: result.result?.id,
          payments: batch.payments.length,
          amount: batch.totalAmount,
        });
      }
    } catch (error) {
      console.log(`‚ÑπÔ∏è [BATCH ${batchIndex + 1}] Respuesta:`, error.message);

      if (error.message && error.message.includes('Request was canceled by the user')) {
        // Cancelaci√≥n normal del usuario - no es un error
        console.log(`üë§ [BATCH ${batchIndex + 1}] Usuario cancel√≥ la operaci√≥n`);
        batch.status = 'pending'; // Volver a estado pendiente para poder reintentarlo
        batch.result = { canceled: true };

        showNotification(
          window.i18n.payments.notifications.batchCanceled.replace('{index}', (batchIndex + 1).toString()),
          'info'
        );
        batchPaymentInProgress = false;
        return false; // Detener el proceso
      } else {
        // Error real
        console.error(`‚ùå [BATCH ${batchIndex + 1}] Error real:`, error);
        batch.status = 'failed';
        batch.result = { error: error.message };

        // Marcar pagos individuales como fallidos
        batch.payments.forEach(payment => {
          payment.status = 'error';
          payment.error = error.message;
        });

        showNotification(
          window.i18n.payments.notifications.batchError
            .replace('{index}', (batchIndex + 1).toString())
            .replace('{error}', error.message),
          'error'
        );

        batchResults.push({
          batchIndex,
          success: false,
          error: error.message,
          payments: batch.payments.length,
          amount: batch.totalAmount,
        });
      }
    }

    updateBatchProgress();
    updatePaymentUI();
    return true; // Continuar con el siguiente lote
  }

  // üÜï Funci√≥n principal para ejecutar pagos por lotes
  async function executePaymentsByBatches(startFromBatch = 0) {
    if (batchPaymentInProgress) {
      showNotification(window.i18n.payments.notifications.alreadyInProgress, 'warning');
      return;
    }

    if (!currentUser) {
      showNotification(window.i18n.payments.notifications.noUser, 'error');
      return;
    }

    const payments = window.currentPayments || [];
    if (payments.length === 0) {
      showNotification(window.i18n.payments.notifications.noPayments, 'warning');
      return;
    }

    // Crear lotes si no existen o si es la primera vez
    if (paymentBatches.length === 0 || startFromBatch === 0) {
      paymentBatches = createPaymentBatches(payments);
      batchResults = [];
      currentBatchIndex = 0;
    }

    batchPaymentInProgress = true;
    currentBatchIndex = startFromBatch;

    showNotification(
      window.i18n.payments.notifications.batchStarting
        .replace('{start}', (startFromBatch + 1).toString())
        .replace('{total}', paymentBatches.length.toString())
        .replace('{size}', BATCH_SIZE.toString()),
      'info'
    );

    updateBatchProgress();

    // Ejecutar lotes secuencialmente
    for (let i = startFromBatch; i < paymentBatches.length; i++) {
      currentBatchIndex = i;

      const shouldContinue = await executeBatchPayment(i);
      if (!shouldContinue) {
        batchPaymentInProgress = false;
        return; // El usuario cancel√≥, detener el proceso
      }

      // Peque√±a pausa entre lotes para no sobrecargar
      if (i < paymentBatches.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    batchPaymentInProgress = false;

    // Mostrar resumen final
    const successfulBatches = batchResults.filter(r => r.success).length;
    const failedBatches = batchResults.filter(r => !r.success).length;
    const canceledBatches = paymentBatches.filter(b => b.result?.canceled).length;
    const totalSuccess = batchResults
      .filter(r => r.success)
      .reduce((sum, r) => sum + r.payments, 0);
    const totalAmount = batchResults
      .filter(r => r.success)
      .reduce((sum, r) => sum + parseFloat(r.amount), 0);

    let summaryMessage = window.i18n.payments.notifications.allCompleted
      .replace('{successful}', successfulBatches.toString())
      .replace('{payments}', totalSuccess.toString())
      .replace('{amount}', totalAmount.toFixed(3));

    if (failedBatches > 0) {
      summaryMessage += window.i18n.payments.notifications.withFailures
        .replace('{failed}', failedBatches.toString());
    }

    if (canceledBatches > 0) {
      summaryMessage += window.i18n.payments.notifications.withCanceled
        .replace('{canceled}', canceledBatches.toString());
    }

    if (canceledBatches > 0 || failedBatches > 0) {
      summaryMessage += window.i18n.payments.notifications.canContinue;
    }

    showNotification(
      summaryMessage,
      successfulBatches > 0 ? 'success' : canceledBatches > 0 ? 'info' : 'warning'
    );
  }

  // üÜï Funci√≥n para continuar desde el √∫ltimo lote fallido
  function continueFromLastBatch() {
    const lastPendingBatch = paymentBatches.findIndex(
      b => b.status === 'pending' || b.status === 'failed' || b.result?.canceled
    );
    if (lastPendingBatch !== -1) {
      // Resetear lotes cancelados a pendientes antes de continuar
      paymentBatches.forEach(batch => {
        if (batch.result?.canceled) {
          batch.status = 'pending';
          batch.result = null;
        }
      });

      executePaymentsByBatches(lastPendingBatch);
    } else {
      showNotification(window.i18n.payments.notifications.noPendingBatches, 'info');
    }
  }

  // Funci√≥n para actualizar la interfaz
  function updatePaymentUI() {
    const payments = window.currentPayments || [];
    const paymentBatch = window.currentPaymentBatch || null;

    if (payments.length === 0) {
      const summary = document.getElementById('payment-summary');
      if (summary) summary.classList.add('hidden');
      return;
    }

    const summary = document.getElementById('payment-summary');
    if (summary) summary.classList.remove('hidden');

    const totalPayments = document.getElementById('total-payments');
    if (totalPayments) totalPayments.textContent = payments.length.toString();

    const totalAmount = document.getElementById('total-amount');
    if (totalAmount) {
      const total = payments.reduce((sum, payment) => sum + payment.amount, 0);
      totalAmount.textContent = `${total.toFixed(3)} HIVE`;
    }

    const connectedUser = document.getElementById('connected-user');
    if (connectedUser) connectedUser.textContent = currentUser || 'No conectado';

    const hasUser = !!currentUser;
    const executeAllBtn = document.getElementById('execute-all-payments');
    if (executeAllBtn) executeAllBtn.disabled = !hasUser;

    // üÜï Actualizar estado de botones de lotes
    const executeBatchBtn = document.getElementById('execute-batch-payments');
    if (executeBatchBtn) executeBatchBtn.disabled = !hasUser;

    const continueBatchBtn = document.getElementById('continue-batch-payments');
    if (continueBatchBtn) {
      const hasPendingBatches = paymentBatches.some(
        b => b.status === 'pending' || b.status === 'failed' || b.result?.canceled
      );
      continueBatchBtn.disabled = !hasUser || !hasPendingBatches;
    }

    if (paymentBatch && paymentBatch.groups) {
      const { high, medium, low } = paymentBatch.groups;

      const highCount = document.getElementById('high-group-count');
      if (highCount) highCount.textContent = high.count.toString();

      const highAmount = document.getElementById('high-group-amount');
      if (highAmount) highAmount.textContent = high.totalAmount + ' HIVE';

      const mediumCount = document.getElementById('medium-group-count');
      if (mediumCount) mediumCount.textContent = medium.count.toString();

      const mediumAmount = document.getElementById('medium-group-amount');
      if (mediumAmount) mediumAmount.textContent = medium.totalAmount + ' HIVE';

      const lowCount = document.getElementById('low-group-count');
      if (lowCount) lowCount.textContent = low.count.toString();

      const lowAmount = document.getElementById('low-group-amount');
      if (lowAmount) lowAmount.textContent = low.totalAmount + ' HIVE';

      const executeHighBtn = document.getElementById('execute-high-payments');
      if (executeHighBtn) executeHighBtn.disabled = !hasUser || high.count === 0;

      const executeMediumBtn = document.getElementById('execute-medium-payments');
      if (executeMediumBtn) executeMediumBtn.disabled = !hasUser || medium.count === 0;

      const executeLowBtn = document.getElementById('execute-low-payments');
      if (executeLowBtn) executeLowBtn.disabled = !hasUser || low.count === 0;
    }
  }

  // Funci√≥n para ejecutar pagos usando el servicio de m√∫ltiples transferencias
  async function executePayments(paymentsToExecute, groupName = 'todos los pagos') {
    if (!currentUser) {
      showNotification(window.i18n.payments.notifications.noUser, 'error');
      return;
    }

    if (!paymentsToExecute || paymentsToExecute.length === 0) {
      showNotification(window.i18n.payments.notifications.noPayments, 'warning');
      return;
    }

    try {
      showNotification(
        window.i18n.payments.notifications.initiating.replace('{count}', paymentsToExecute.length.toString()),
        'info'
      );

      // Construir operaciones para requestBroadcast
      const operations = paymentsToExecute.map(payment => [
        'transfer',
        {
          from: currentUser,
          to: payment.to,
          amount: `${payment.amount.toFixed(3)} HIVE`,
          memo: payment.memo || window.i18n.memo.defaults.basic.replace('{period}', ''),
        },
      ]);

      // Debug: mostrar las operaciones que se van a enviar
      console.log(
        `üí∏ [PAYMENTS] Enviando ${operations.length} operaciones:`,
        operations.slice(0, 3)
      );

      // Usar directamente requestBroadcast de Keychain
      const result = await new Promise((resolve, reject) => {
        if (!window.hive_keychain) {
          reject(new Error(window.i18n.payments.notifications.keychainNotAvailable));
          return;
        }

        window.hive_keychain.requestBroadcast(currentUser, operations, 'active', response => {
          if (response.success) {
            resolve(response);
          } else {
            reject(new Error(response.message || response.error || window.i18n.payments.notifications.unknownError));
          }
        });
      });

      if (result.success) {
        const totalAmount = paymentsToExecute.reduce((sum, p) => sum + p.amount, 0);

        showNotification(
          window.i18n.payments.notifications.success
            .replace('{name}', groupName)
            .replace('{amount}', totalAmount.toFixed(3))
            .replace('{txId}', result.result?.id || ''),
          'success'
        );

        // Marcar pagos como completados
        paymentsToExecute.forEach(payment => {
          payment.status = 'success';
        });

        updatePaymentUI();
      }
    } catch (error) {
      console.log(`‚ÑπÔ∏è [PAYMENTS] Respuesta:`, error.message);

      if (error && error.message && error.message.includes('Request was canceled by the user')) {
        // Cancelaci√≥n normal del usuario - no es un error
        console.log(`üë§ [PAYMENTS] Usuario cancel√≥ la operaci√≥n`);
        showNotification(window.i18n.payments.notifications.userCanceled, 'info');
      } else {
        // Error real
        console.error(`‚ùå [PAYMENTS] Error real:`, error);
        showNotification(
          window.i18n.payments.notifications.error
            .replace('{name}', groupName)
            .replace('{error}', error.message),
          'error'
        );
      }
    }
  }

  // Funci√≥n para alternar vista de grupos
  function toggleGroupView() {
    isGroupView = !isGroupView;
    updatePaymentUI();
  }

  // Funci√≥n global para ejecutar pagos de grupo
  window.executeGroupPayments = function (groupId) {
    const paymentBatch = window.currentPaymentBatch;
    if (!paymentBatch) return;

    const groupData = paymentBatch.groups[groupId];
    if (!groupData || groupData.count === 0) return;

    const groupNames = {
      high: 'pagos de alto valor',
      medium: 'pagos de valor medio',
      low: 'pagos de bajo valor',
    };

    executePayments(groupData.payments, groupNames[groupId] || 'pagos del grupo');
  };

  // Funci√≥n de inicializaci√≥n principal
  function initializePaymentSystem() {
    console.log('üîÑ Inicializando sistema de pagos...');

    currentUser = localStorage.getItem('authenticated_user');

    if (!currentUser) {
      showNotification(window.i18n.payments.notifications.noUserRedirecting, 'warning');
      setTimeout(() => (window.location.href = '/'), 2000);
      return;
    }

    isGroupView = window.isGroupView || false;
    updatePaymentUI();

    if (isGroupView && window.currentPaymentBatch) {
      toggleGroupView();
    }

    // Event listeners (remover listeners existentes primero)
    setupEventListeners();

    // Limpiar URL
    cleanupURL();

    console.log('‚úÖ Sistema de pagos inicializado correctamente');
  }

  // Funci√≥n para configurar event listeners
  function setupEventListeners() {
    // Remover listeners existentes para evitar duplicados
    const executeAllBtn = document.getElementById('execute-all-payments');
    if (executeAllBtn) {
      executeAllBtn.replaceWith(executeAllBtn.cloneNode(true));
      const newExecuteAllBtn = document.getElementById('execute-all-payments');
      if (newExecuteAllBtn) {
        newExecuteAllBtn.addEventListener('click', () => {
          executePayments(window.currentPayments, 'todos los pagos');
        });
      }
    }

    // üÜï Bot√≥n para pagos por lotes
    const executeBatchBtn = document.getElementById('execute-batch-payments');
    if (executeBatchBtn) {
      executeBatchBtn.replaceWith(executeBatchBtn.cloneNode(true));
      const newExecuteBatchBtn = document.getElementById('execute-batch-payments');
      if (newExecuteBatchBtn) {
        newExecuteBatchBtn.addEventListener('click', () => {
          executePaymentsByBatches(0);
        });
      }
    }

    // üÜï Bot√≥n para continuar lotes
    const continueBatchBtn = document.getElementById('continue-batch-payments');
    if (continueBatchBtn) {
      continueBatchBtn.replaceWith(continueBatchBtn.cloneNode(true));
      const newContinueBatchBtn = document.getElementById('continue-batch-payments');
      if (newContinueBatchBtn) {
        newContinueBatchBtn.addEventListener('click', continueFromLastBatch);
      }
    }

    // üÜï Bot√≥n para resetear lotes
    const resetBatchBtn = document.getElementById('reset-batch-payments');
    if (resetBatchBtn) {
      resetBatchBtn.replaceWith(resetBatchBtn.cloneNode(true));
      const newResetBatchBtn = document.getElementById('reset-batch-payments');
      if (newResetBatchBtn) {
        newResetBatchBtn.addEventListener('click', () => {
          paymentBatches = [];
          batchResults = [];
          currentBatchIndex = 0;
          batchPaymentInProgress = false;
          updateBatchProgress();
          showNotification(window.i18n.payments.notifications.batchesReset, 'info');
        });
      }
    }

    const toggleGroupBtn = document.getElementById('toggle-group-view');
    if (toggleGroupBtn) {
      toggleGroupBtn.replaceWith(toggleGroupBtn.cloneNode(true));
      const newToggleGroupBtn = document.getElementById('toggle-group-view');
      if (newToggleGroupBtn) {
        newToggleGroupBtn.addEventListener('click', toggleGroupView);
      }
    }

    const refreshBtn = document.getElementById('refresh-data');
    if (refreshBtn) {
      refreshBtn.replaceWith(refreshBtn.cloneNode(true));
      const newRefreshBtn = document.getElementById('refresh-data');
      if (newRefreshBtn) {
        newRefreshBtn.addEventListener('click', () => window.location.reload());
      }
    }
  }

  // Funci√≥n para limpiar la URL
  function cleanupURL() {
    const url = new URL(window.location.href);
    if (url.searchParams.has('data')) {
      const hasGroups = url.searchParams.has('groups');
      url.searchParams.delete('data');
      if (!hasGroups) url.searchParams.delete('groups');
      window.history.replaceState({}, '', url.toString());
    }
  }

  // Funci√≥n para detectar si la p√°gina est√° completamente cargada
  function isPageReady() {
    return document.readyState === 'complete' || document.readyState === 'interactive';
  }

  // Funci√≥n para inicializar con retry
  function initializeWithRetry(maxRetries = 3, delay = 100) {
    let retries = 0;

    function tryInitialize() {
      if (document.getElementById('payment-summary')) {
        initializePaymentSystem();
        return;
      }

      if (retries < maxRetries) {
        retries++;
        console.log(`üîÑ Reintentando inicializaci√≥n (${retries}/${maxRetries})`);
        setTimeout(tryInitialize, delay);
      } else {
        console.error('‚ùå No se pudo inicializar el sistema de pagos');
      }
    }

    tryInitialize();
  }

  // M√∫ltiples puntos de entrada para asegurar la inicializaci√≥n

  // 1. DOMContentLoaded - Para carga inicial
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOMContentLoaded event');
    initializeWithRetry();
  });

  // 2. Load event - Para asegurar que todo est√© cargado
  window.addEventListener('load', () => {
    console.log('üåê Window load event');
    initializeWithRetry();
  });

  // 3. Astro View Transitions - Para navegaci√≥n SPA
  document.addEventListener('astro:page-load', () => {
    console.log('üöÄ Astro page load event');
    setupMutationObserver();
    initializeWithRetry();
  });

  // 4. Astro antes de la navegaci√≥n - Para limpiar estados anteriores
  document.addEventListener('astro:before-preparation', () => {
    console.log('üßπ Limpiando estado antes de navegaci√≥n');
    // Limpiar observador si existe
    if (observer) {
      observer.disconnect();
    }
  });

  // 5. Observador de mutaciones para detectar cambios en el DOM
  function setupMutationObserver() {
    // Desconectar observador anterior si existe
    if (observer) {
      observer.disconnect();
    }

    observer = new MutationObserver(mutations => {
      for (const mutation of mutations) {
        if (mutation.type === 'childList') {
          const paymentSummary = document.getElementById('payment-summary');
          if (paymentSummary && !paymentSummary.dataset.initialized) {
            console.log('üîç Detectado componente payment-summary, inicializando...');
            paymentSummary.dataset.initialized = 'true';
            initializeWithRetry();
            break;
          }
        }
      }
    });

    // Iniciar observaci√≥n
    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  }

  // 6. Evento personalizado de Aliento para transiciones
  document.addEventListener('aliento:page-ready', () => {
    console.log('üéØ Aliento: P√°gina lista, inicializando sistema de pagos');
    setupMutationObserver();
    initializeWithRetry();
  });

  // 7. Configurar observador en cada carga
  setupMutationObserver();

  // 8. Inicializaci√≥n inmediata si la p√°gina ya est√° lista
  if (isPageReady()) {
    console.log('‚ö° P√°gina ya lista, inicializando inmediatamente');
    setTimeout(() => initializeWithRetry(), 50);
  }
</script>
