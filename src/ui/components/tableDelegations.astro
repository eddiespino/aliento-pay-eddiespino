---
// Tabla de delegaciones con skeleton loading mejorado
---

<div class="bg-[var(--bgElevated)] rounded-2xl border border-[var(--border)] shadow-xl overflow-hidden mb-8">
  <div class="p-6 border-b border-[var(--border)]">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-xl font-bold text-[var(--fg)]">Current Delegations</h2>
        <p class="text-[var(--mutedFg)] text-sm mt-1">All active delegations to your account</p>
        <div class="flex items-center gap-2 mt-2">
          <div class="bg-anakiwa-500/10 border border-anakiwa-500/50 rounded-lg px-2 py-1">
            <span class="text-anakiwa-400 text-xs font-medium">‚ö° Optimized</span>
          </div>
          <span class="text-[var(--mutedFg)] text-xs">Essential data only - instant loading</span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="delegation-stats" class="text-right text-sm">
          <p class="text-[var(--mutedFg)]">Total Delegations</p>
          <p id="total-delegations" class="text-[var(--fg)] font-bold">--</p>
        </div>
        <div class="text-right text-sm">
          <p class="text-[var(--mutedFg)]">Total HP</p>
          <p id="total-hp-display" class="text-anakiwa-400 font-bold">-- HP</p>
        </div>
        <button
          id="copy-markdown-btn"
          class="bg-[var(--bg)] hover:bg-[var(--border)] text-[var(--fg)] font-medium py-2 px-4 rounded-lg border border-[var(--border)] shadow transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-anakiwa-400 focus:ring-offset-2 flex items-center gap-2"
          title="Copy as Markdown for Hive posts"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
            ></path>
          </svg>
          <span class="hidden sm:inline">Copy MD</span>
        </button>
        <button
          id="refresh-btn"
          class="bg-anakiwa-500 hover:bg-anakiwa-600 text-[var(--primary-contrast)] font-medium py-2 px-4 rounded-lg shadow transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-anakiwa-400 focus:ring-offset-2 flex items-center gap-2"
          title="Refresh delegations"
        >
          <svg
            id="refresh-icon"
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          <span class="hidden sm:inline">Refresh</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Skeleton Loading State -->
  <div id="skeleton-state" class="hidden">
    <!-- Skeleton para estad√≠sticas -->
    <div class="p-6 border-b border-[#232329]">
      <div class="flex justify-between items-center">
        <div class="flex-1">
          <div class="h-6 bg-gray-600 rounded w-48 mb-2 animate-pulse"></div>
          <div class="h-4 bg-gray-700 rounded w-64 animate-pulse"></div>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-right">
            <div class="h-3 bg-gray-700 rounded w-24 mb-1 animate-pulse"></div>
            <div class="h-5 bg-gray-600 rounded w-12 animate-pulse"></div>
          </div>
          <div class="text-right">
            <div class="h-3 bg-gray-700 rounded w-16 mb-1 animate-pulse"></div>
            <div class="h-5 bg-gray-600 rounded w-20 animate-pulse"></div>
          </div>
          <div class="h-10 bg-gray-600 rounded-lg w-24 animate-pulse"></div>
        </div>
      </div>
    </div>

    <!-- Skeleton para tabla -->
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="bg-[#232329]">
            <th class="text-left py-4 px-6">
              <div class="h-4 bg-gray-600 rounded w-20 animate-pulse"></div>
            </th>
            <th class="text-left py-4 px-6">
              <div class="h-4 bg-gray-600 rounded w-12 animate-pulse"></div>
            </th>
            <th class="text-left py-4 px-6">
              <div class="h-4 bg-gray-600 rounded w-16 animate-pulse"></div>
            </th>
            <th class="text-left py-4 px-6">
              <div class="h-4 bg-gray-600 rounded w-16 animate-pulse"></div>
            </th>
            <th class="text-left py-4 px-6">
              <div class="h-4 bg-gray-600 rounded w-24 animate-pulse"></div>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Skeleton rows -->
          {
            Array.from({ length: 8 }).map(() => (
              <tr class="border-b border-[#232329] last:border-b-0">
                <td class="py-4 px-6">
                  <div class="flex items-center gap-3">
                    <div class="h-8 w-8 bg-gray-600 rounded-full animate-pulse" />
                    <div class="h-4 bg-gray-600 rounded w-24 animate-pulse" />
                  </div>
                </td>
                <td class="py-4 px-6">
                  <div class="h-4 bg-gray-600 rounded w-20 animate-pulse" />
                </td>
                <td class="py-4 px-6">
                  <div class="h-4 bg-gray-600 rounded w-16 animate-pulse" />
                </td>
                <td class="py-4 px-6">
                  <div class="h-4 bg-gray-600 rounded w-32 animate-pulse" />
                </td>
                <td class="py-4 px-6">
                  <div class="h-4 bg-gray-600 rounded w-20 animate-pulse" />
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>

    <!-- Loading progress indicator -->
    <div class="p-4 bg-[#232329] border-t border-[#2a2a32]">
      <div class="flex items-center justify-center gap-3 text-gray-400 text-sm">
        <svg
          class="animate-spin h-4 w-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <span id="loading-progress">Cargando delegaciones...</span>
      </div>
    </div>
  </div>

  <!-- Fallback Loading State (for compatibility) -->
  <div id="loading-state" class="p-8 text-center hidden">
    <div class="flex flex-col items-center gap-4">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-anakiwa-500"></div>
      <div>
        <p class="text-[var(--fg)] font-medium">Loading delegations...</p>
        <p id="loading-progress-fallback" class="text-[var(--mutedFg)] text-sm mt-1">Initializing...</p>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-state" class="p-8 text-center hidden">
    <div class="flex flex-col items-center gap-3">
      <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <p class="text-lg font-medium text-[var(--fg)]">Error loading delegations</p>
        <p id="error-message" class="text-red-300 text-sm mt-1">Something went wrong</p>
        <button
          id="retry-btn"
          class="mt-3 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow transition-all duration-150"
        >
          Try Again
        </button>
      </div>
    </div>
  </div>

  <!-- Search and Filters Bar -->
  <div id="search-filters-bar" class="px-6 py-4 border-b border-[var(--border)] hidden">
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
      <!-- Search Input -->
      <div class="relative flex-1 max-w-md">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-[var(--mutedFg)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <input
          type="text"
          id="search-delegators"
          placeholder="Search delegators..."
          class="block w-full pl-10 pr-4 py-2 bg-[var(--bg)] border border-[var(--border)] rounded-lg text-[var(--fg)] placeholder-[var(--mutedFg)] focus:outline-none focus:ring-2 focus:ring-anakiwa-500 focus:border-transparent transition-all"
        />
      </div>

      <!-- Results Info and Pagination -->
      <div class="flex items-center gap-4 flex-wrap">
        <span id="results-count" class="text-sm text-[var(--mutedFg)]">
          Showing <span id="visible-count" class="text-[var(--fg)] font-medium">0</span> of <span id="total-count" class="text-[var(--fg)] font-medium">0</span>
        </span>
        <button
          id="clear-search-btn"
          class="text-sm text-anakiwa-400 hover:text-anakiwa-300 transition-colors hidden"
        >
          Clear
        </button>

        <!-- Items per page selector -->
        <div class="flex items-center gap-2 text-sm">
          <span class="text-[var(--mutedFg)]">Per page:</span>
          <select
            id="items-per-page"
            class="bg-[var(--bg)] border border-[var(--border)] rounded-lg px-2 py-1 text-[var(--fg)] focus:outline-none focus:ring-2 focus:ring-anakiwa-500 cursor-pointer"
          >
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div id="pagination-controls" class="px-6 py-3 border-b border-[var(--border)] hidden">
    <div class="flex items-center justify-between">
      <button
        id="prev-page-btn"
        class="px-3 py-1.5 rounded-lg border border-[var(--border)] text-[var(--fg)] hover:bg-[var(--bg)] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        disabled
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        <span>Previous</span>
      </button>

      <div id="page-numbers" class="flex items-center gap-1">
        <!-- Page numbers will be inserted here -->
      </div>

      <button
        id="next-page-btn"
        class="px-3 py-1.5 rounded-lg border border-[var(--border)] text-[var(--fg)] hover:bg-[var(--bg)] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        disabled
      >
        <span>Next</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Table Container -->
  <div id="table-container" class="overflow-x-auto hidden">
    <table class="w-full">
      <thead>
        <tr class="bg-[var(--bg)]">
          <th class="text-left py-4 px-6 text-sm font-semibold text-[var(--mutedFg)] cursor-pointer hover:text-[var(--fg)] transition-colors group" data-sort="delegator">
            <div class="flex items-center gap-2">
              <span>Delegator</span>
              <svg class="w-4 h-4 opacity-0 group-hover:opacity-50 transition-all duration-200 sort-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"/>
              </svg>
            </div>
          </th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-[var(--mutedFg)] cursor-pointer hover:text-[var(--fg)] transition-colors group" data-sort="hp">
            <div class="flex items-center gap-2">
              <span>HP</span>
              <svg class="w-4 h-4 opacity-0 group-hover:opacity-50 transition-all duration-200 sort-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"/>
              </svg>
            </div>
          </th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-[var(--mutedFg)] cursor-pointer hover:text-[var(--fg)] transition-colors group" data-sort="date">
            <div class="flex items-center gap-2">
              <span>Date</span>
              <svg class="w-4 h-4 opacity-0 group-hover:opacity-50 transition-all duration-200 sort-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"/>
              </svg>
            </div>
          </th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-[var(--mutedFg)]">
            <div class="flex items-center gap-2">
              <span>USD Value</span>
              <span id="hive-price-badge" class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400">
                $--
              </span>
            </div>
          </th>
          <th class="text-left py-4 px-6 text-sm font-semibold text-[var(--mutedFg)]"> % Share </th>
        </tr>
      </thead>
      <tbody id="delegations-tbody">
        <!-- Delegations will be inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="p-12 text-center hidden">
    <div class="flex flex-col items-center gap-3">
      <svg class="w-16 h-16 text-[var(--mutedFg)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        ></path>
      </svg>
      <div>
        <p class="text-lg font-medium text-[var(--fg)]">No delegations found</p>
        <p class="text-[var(--mutedFg)] text-sm">You don't have any active delegations yet</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Import required modules - dynamic imports for client-side compatibility
  console.log('üöÄ [DELEGATIONS] Script loaded and executing');

  // Cache settings
  const CACHE_KEY_PREFIX = 'delegationsCache';
  const CACHE_DURATION = 3 * 60 * 1000; // 3 minutos en ms

  // Get cache key for specific user
  function getCacheKey(username: string): string {
    return `${CACHE_KEY_PREFIX}_${username}`;
  }

  // Importar servicio global de avatar cache
  let avatarCacheService: any = null;

  // Funci√≥n para inicializar el servicio de avatar cache
  async function initAvatarCache() {
    if (!avatarCacheService) {
      const { getAvatarCache } = await import('../../lib/avatar-cache');
      avatarCacheService = getAvatarCache();
    }
    return avatarCacheService;
  }

  // Funci√≥n para obtener avatar con el nuevo servicio
  async function getCachedAvatarUrl(username: string): Promise<string> {
    if (!username) return '';

    const cache = await initAvatarCache();
    return cache.getAvatarUrl(username);
  }

  // ‚úÖ REFACTORIZADO: Estado global robusto para evitar m√∫ltiples cargas
  let currentDelegations: unknown[] = [];
  let isLoading = false;
  let isInitialized = false;
  let loadingPromise: Promise<void> | null = null;
  let currentAbortController: AbortController | null = null;

  // DOM elements - with safe null checks
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const tableContainer = document.getElementById('table-container');
  const emptyState = document.getElementById('empty-state');
  const delegationsTbody = document.getElementById('delegations-tbody');
  const totalDelegations = document.getElementById('total-delegations');
  const totalHpDisplay = document.getElementById('total-hp-display');
  const loadingProgress = document.getElementById('loading-progress');
  const errorMessage = document.getElementById('error-message');
  const refreshBtn = document.getElementById('refresh-btn');
  const refreshIcon = document.getElementById('refresh-icon');
  const retryBtn = document.getElementById('retry-btn');
  const skeletonState = document.getElementById('skeleton-state');
  const searchFiltersBar = document.getElementById('search-filters-bar');
  const searchInput = document.getElementById('search-delegators') as HTMLInputElement;
  const clearSearchBtn = document.getElementById('clear-search-btn');
  const visibleCountEl = document.getElementById('visible-count');
  const totalCountEl = document.getElementById('total-count');
  const paginationControls = document.getElementById('pagination-controls');
  const prevPageBtn = document.getElementById('prev-page-btn');
  const nextPageBtn = document.getElementById('next-page-btn');
  const pageNumbersEl = document.getElementById('page-numbers');
  const itemsPerPageSelect = document.getElementById('items-per-page') as HTMLSelectElement;

  // Filtered delegations for search
  let filteredDelegations: unknown[] = [];

  // Pagination state
  let currentPage = 1;
  let itemsPerPage = 25;

  // USD Price state
  let hivePrice = 0;
  let priceLoading = true;

  // State management
  function showLoading(message = 'Cargando delegaciones...') {
    hideAllStates();
    // Preferir skeleton state sobre loading simple
    if (skeletonState) {
      skeletonState.classList.remove('hidden');
      if (loadingProgress) loadingProgress.textContent = message;
    } else {
      loadingState?.classList.remove('hidden');
      const fallbackProgress = document.getElementById('loading-progress-fallback');
      if (fallbackProgress) fallbackProgress.textContent = message;
    }
  }

  function showError(message = 'Something went wrong') {
    hideAllStates();
    errorState?.classList.remove('hidden');
    if (errorMessage) errorMessage.textContent = message;
  }

  function showTable() {
    hideAllStates();
    tableContainer?.classList.remove('hidden');
    searchFiltersBar?.classList.remove('hidden');
    paginationControls?.classList.remove('hidden');
  }

  function showEmpty() {
    hideAllStates();
    emptyState?.classList.remove('hidden');
  }

  function hideAllStates() {
    skeletonState?.classList.add('hidden');
    loadingState?.classList.add('hidden');
    errorState?.classList.add('hidden');
    tableContainer?.classList.add('hidden');
    emptyState?.classList.add('hidden');
    searchFiltersBar?.classList.add('hidden');
    paginationControls?.classList.add('hidden');
  }

  // Utility functions (unused functions removed for optimization)

  // Format relative time (e.g., "4 years ago")
  function getTimeAgo(date: Date): string {
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHr = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHr / 24);
    const diffWeek = Math.floor(diffDay / 7);
    const diffMonth = Math.floor(diffDay / 30);
    const diffYear = Math.floor(diffDay / 365);

    if (diffYear > 0) return `${diffYear} year${diffYear > 1 ? 's' : ''} ago`;
    if (diffMonth > 0) return `${diffMonth} month${diffMonth > 1 ? 's' : ''} ago`;
    if (diffWeek > 0) return `${diffWeek} week${diffWeek > 1 ? 's' : ''} ago`;
    if (diffDay > 0) return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
    if (diffHr > 0) return `${diffHr} hour${diffHr > 1 ? 's' : ''} ago`;
    if (diffMin > 0) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
    return 'just now';
  }

  // Fetch HIVE price from CoinGecko
  async function fetchHivePrice(): Promise<number> {
    try {
      console.log('üí∞ Fetching HIVE price from CoinGecko...');
      const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=hive&vs_currencies=usd');
      const data = await response.json();
      const price = data.hive?.usd || 0;
      console.log(`‚úÖ HIVE price: $${price.toFixed(4)}`);
      return price;
    } catch (error) {
      console.error('‚ùå Error fetching HIVE price:', error);
      return 0;
    }
  }

  // Render delegations table (updated to use async avatar loading)
  async function renderDelegations(delegations: unknown[]): Promise<void> {
    if (!delegationsTbody) return;

    delegationsTbody.innerHTML = '';

    // Precargar avatares para todos los delegadores
    const usernames = delegations.map((d: any) => d.delegator).filter(Boolean);
    const cache = await initAvatarCache();
    await cache.preloadAvatars(usernames);

    for (const [index, delegation] of delegations.entries()) {
      const row = document.createElement('tr');
      row.className = `border-b border-[var(--border)] hover:bg-[var(--bg)] transition-colors ${
        index % 2 === 0 ? 'bg-[var(--bgElevated)]' : 'bg-[var(--bg)]'
      }`;

      // Type assertion para delegation
      const del = delegation as any;

      // Obtener avatar URL usando el cache optimizado
      const avatarUrl = await getCachedAvatarUrl(del.delegator);

      // Format date
      const delegationDate = del.date ? new Date(del.date) : (del.timestamp ? new Date(del.timestamp) : null);
      const dateStr = delegationDate ? delegationDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '---';
      const timeAgo = delegationDate ? getTimeAgo(delegationDate) : '';

      row.innerHTML = `
        <td class="py-4 px-6">
          <div class="flex items-center gap-3">
            <img
              src="${avatarUrl}"
              alt="@${del.delegator}"
              class="w-8 h-8 rounded-full object-cover bg-[var(--border)]"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="w-8 h-8 rounded-full bg-[var(--border)] flex items-center justify-center text-[var(--fg)] text-sm font-bold" style="display: none;">
              ${del.delegator.substring(0, 2).toUpperCase()}
            </div>
            <div>
              <p class="text-[var(--fg)] text-xl font-medium">@${del.delegator}</p>
            </div>
          </div>
        </td>
        <td class="py-4 px-6">
          <p class="text-anakiwa-400 font-bold text-lg">${del.hpAmount.toLocaleString('en-US')} HP</p>
          <p class="text-[var(--mutedFg)] text-xs">Hive Power</p>
        </td>
        <td class="py-4 px-6">
          <p class="text-[var(--fg)] font-medium">${dateStr}</p>
          <p class="text-[var(--mutedFg)] text-xs">${timeAgo}</p>
        </td>
        <td class="py-4 px-6">
          ${hivePrice > 0 ? `
            <p class="text-green-400 font-bold text-lg">$${(del.hpAmount * hivePrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
            <p class="text-[var(--mutedFg)] text-xs">USD Value</p>
          ` : `
            <p class="text-[var(--mutedFg)] text-sm">Loading...</p>
          `}
        </td>
        <td class="py-4 px-6">
          <div class="flex items-center gap-2">
            <p class="text-anakiwa-400 font-bold text-lg">${(del.participationPercentage || 0).toFixed(2)}%</p>
            <div class="w-16 bg-[var(--border)] rounded-full h-2">
              <div
                class="bg-gradient-to-r from-anakiwa-400 to-anakiwa-600 h-2 rounded-full transition-all duration-300"
                style="width: ${Math.min(100, del.participationPercentage || 0)}%"
              ></div>
            </div>
          </div>
          <p class="text-[var(--mutedFg)] text-xs">of total HP</p>
        </td>
      `;
      delegationsTbody.appendChild(row);
    }

    // Update stats with USA formatting
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const totalHp = delegations.reduce((sum: number, d: any) => sum + (d.hpAmount || 0), 0);
    if (totalDelegations) totalDelegations.textContent = delegations.length.toString();
    if (totalHpDisplay) totalHpDisplay.textContent = `${totalHp.toLocaleString('en-US')} HP`;
    // Emitir evento global para el header
    window.dispatchEvent(new CustomEvent('delegations:totalHP', { detail: totalHp }));
  }

  // ‚úÖ REFACTORIZADO: Funci√≥n robusta para cargar delegaciones
  async function loadDelegations() {
    // üõ°Ô∏è Evitar m√∫ltiples cargas simult√°neas
    if (isLoading) {
      console.log('‚ö†Ô∏è Ya est√° cargando delegaciones, saltando...');
      return;
    }

    // üîÑ Si ya hay una carga en progreso, esperar a que termine
    if (loadingPromise) {
      console.log('‚è≥ Esperando carga en progreso...');
      return loadingPromise;
    }

    // üö´ Cancelar cualquier request HTTP previo
    if (currentAbortController) {
      currentAbortController.abort();
      console.log('üö´ Cancelando requests HTTP previos de delegaciones');
    }

    // üÜï Crear nuevo AbortController para esta carga
    currentAbortController = new AbortController();

    let username: string | null = null;

    // üìù Marcar como carga en progreso
    loadingPromise = (async () => {
      try {
        isLoading = true;
        showLoading('Getting logged user...');

        // ‚úÖ PRIORITY 1: Check localStorage first (most reliable for dashboard)
        console.log('üîç [DELEGATIONS] Checking localStorage...');
        username = localStorage.getItem('authenticated_user');
        console.log('üîç [DELEGATIONS] localStorage value:', username);
        console.log('üîç [DELEGATIONS] All localStorage keys:', Object.keys(localStorage));

        // PRIORITY 2: Try authUseCase if localStorage didn't have it
        if (!username) {
          console.log('‚ö†Ô∏è [DELEGATIONS] No user in localStorage, trying authUseCase...');
          try {
            const { container } = await import('../../application/Container');
            const authUseCase = container.getAuthenticationUseCase();
            username = authUseCase.getCurrentUser();
            console.log('üîç [DELEGATIONS] Got user from authUseCase:', username);
          } catch (authError) {
            console.warn('‚ö†Ô∏è [DELEGATIONS] AuthUseCase not available:', authError);
          }
        }

        if (!username) {
          console.error('‚ùå [DELEGATIONS] No user found anywhere!');
          showError('No user logged in. Please login first.');
          return;
        }

        console.log('‚úÖ [DELEGATIONS] Found authenticated user:', username);

        // üö´ Verificar cancelaci√≥n temprana
        if (currentAbortController?.signal.aborted) {
          console.log('üö´ Carga de delegaciones cancelada');
          return;
        }

        // Check cache first for this specific user
        const userCacheKey = getCacheKey(username);
        const cachedData = localStorage.getItem(userCacheKey);
        if (cachedData) {
          try {
            const cached = JSON.parse(cachedData);
            const now = Date.now();

            if (now - cached.timestamp < CACHE_DURATION) {
              console.log(`‚ö° Using cached data for @${username}`);
              currentDelegations = cached.delegations;

              const totalHP = currentDelegations.reduce(
                (sum, d: any) => sum + (d.hpAmount || 0),
                0
              ) as number;

              // eslint-disable-next-line @typescript-eslint/no-explicit-any
              const cachedWithPercentages = currentDelegations.map((delegation: any) => {
                const participationPercentage =
                  totalHP > 0 ? (delegation.hpAmount / totalHP) * 100 : 0;
                return {
                  ...delegation,
                  participationPercentage: participationPercentage,
                };
              });

              await renderDelegations(cachedWithPercentages);
              showTable();

              // Show cache info
              const cacheAge = Math.floor((now - cached.timestamp) / 1000);
              console.log(
                `üì¶ Cache age: ${cacheAge}s (expires in ${Math.floor((CACHE_DURATION - (now - cached.timestamp)) / 1000)}s)`
              );

              // üìä Resumen del c√°lculo de % Share desde cache
              console.log('üìä Resumen de participaci√≥n (desde cache):');
              cachedWithPercentages.slice(0, 5).forEach((delegation, index) => {
                console.log(
                  `  ${index + 1}. @${delegation.delegator}: ${delegation.participationPercentage.toFixed(2)}%`
                );
              });
              if (cachedWithPercentages.length > 5) {
                console.log(`  ... y ${cachedWithPercentages.length - 5} delegadores m√°s`);
              }

              return;
            } else {
              console.log(`üóëÔ∏è Cache expired for @${username}, loading fresh data`);
              localStorage.removeItem(userCacheKey);
            }
          } catch (cacheError) {
            console.warn('‚ö†Ô∏è Error parsing cache, clearing:', cacheError);
            localStorage.removeItem(userCacheKey);
          }
        }

        showLoading(`Loading delegations for @${username}...`);

        // FAST INITIAL LOAD: Load basic delegation data first
        showLoading(`Loading basic delegation data...`);

        // Get basic delegations first (fast) - dynamic import for client-side compatibility
        const { getAllDelegationsWithDetails } = await import('../../lib/get-delegations');
        currentDelegations = await getAllDelegationsWithDetails(username);

        if (!currentDelegations || currentDelegations.length === 0) {
          showEmpty();
          console.log(`‚ÑπÔ∏è No delegations found for @${username}`);
          return;
        }

        // ‚úÖ CALCULAR % SHARE despu√©s de cargar delegadores
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const totalHP = currentDelegations.reduce((sum, d: any) => sum + (d.hpAmount || 0), 0);
        console.log(`üìä Total HP calculado: ${totalHP.toLocaleString('en-US')} HP`);

        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const basicDetails = currentDelegations.map((delegation: any) => {
          const participationPercentage = totalHP > 0 ? (delegation.hpAmount / totalHP) * 100 : 0;
          console.log(
            `üìà @${delegation.delegator}: ${delegation.hpAmount.toLocaleString('en-US')} HP (${participationPercentage.toFixed(2)}%)`
          );

          return {
            delegator: delegation.delegator,
            hpAmount: delegation.hpAmount,
            participationPercentage: participationPercentage,
            vestsAmount: delegation.amount,
            block_num: delegation.operation_details?.block_num || delegation.block_num,
            // No timestamp or trx_id initially for fast load
          };
        });

        showTable();

        // Initialize filtered delegations and apply pagination
        filteredDelegations = [...basicDetails];
        currentPage = 1; // Reset to first page
        updatePagination();

        console.log(
          `‚úÖ Loaded ${basicDetails.length} delegations with essential data only (OPTIMIZED)`
        );

        // üìä Resumen del c√°lculo de % Share
        console.log('üìä Resumen de participaci√≥n:');
        basicDetails.slice(0, 5).forEach((delegation, index) => {
          console.log(
            `  ${index + 1}. @${delegation.delegator}: ${delegation.participationPercentage.toFixed(2)}%`
          );
        });
        if (basicDetails.length > 5) {
          console.log(`  ... y ${basicDetails.length - 5} delegadores m√°s`);
        }

        // üöÄ OPTIMIZACI√ìN: Solo datos esenciales - tabla limpia y r√°pida
        console.log(
          '‚ö° Dashboard optimizado: Columnas de fecha y transacci√≥n eliminadas para m√°xima velocidad'
        );
      } catch (error) {
        if (error instanceof Error && error.name === 'AbortError') {
          console.log('üö´ Carga de delegaciones cancelada correctamente');
          return;
        }
        console.error('‚ùå Error loading delegations:', error);
        showError((error as Error)?.message || 'Failed to load delegations');
      } finally {
        // Cache the latest delegations with calculated percentages
        if (currentDelegations && currentDelegations.length > 0 && username) {
          const userCacheKey = getCacheKey(username);

          // ‚úÖ Guardar datos con porcentajes calculados
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          const totalHP = currentDelegations.reduce((sum, d: any) => sum + (d.hpAmount || 0), 0);
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          const delegationsWithPercentages = currentDelegations.map((delegation: any) => ({
            ...delegation,
            participationPercentage: totalHP > 0 ? (delegation.hpAmount / totalHP) * 100 : 0,
          }));

          const cacheData = {
            delegations: delegationsWithPercentages,
            timestamp: Date.now(),
            username: username,
          };

          try {
            // Clean old cache entries before saving new ones
            const allKeys = Object.keys(localStorage);
            const oldCacheKeys = allKeys.filter(
              key => key.startsWith(CACHE_KEY_PREFIX) && key !== userCacheKey
            );

            // Remove old cache entries to prevent localStorage overflow
            oldCacheKeys.forEach(key => {
              try {
                localStorage.removeItem(key);
              } catch (e) {
                console.warn('‚ö†Ô∏è Error removing old cache entry:', e);
              }
            });

            localStorage.setItem(userCacheKey, JSON.stringify(cacheData));
            console.log(
              `üíæ Cached ${delegationsWithPercentages.length} delegations with percentages for @${username}`
            );

            if (oldCacheKeys.length > 0) {
              console.log(`üßπ Cleaned ${oldCacheKeys.length} old cache entries`);
            }
          } catch (storageError) {
            console.warn('‚ö†Ô∏è Error saving to cache:', storageError);
            // Try to clear some space and retry once
            try {
              const allKeys = Object.keys(localStorage);
              const cacheKeys = allKeys.filter(key => key.startsWith(CACHE_KEY_PREFIX));
              cacheKeys.forEach(key => localStorage.removeItem(key));
              localStorage.setItem(userCacheKey, JSON.stringify(cacheData));
              console.log('üîÑ Retry cache save successful after cleanup');
            } catch (retryError) {
              console.warn('‚ö†Ô∏è Retry cache save failed:', retryError);
            }
          }
        }

        // ‚úÖ Limpiar estado global
        isLoading = false;
        isInitialized = true;
        loadingPromise = null;

        // Reset refresh button
        if (refreshIcon) {
          refreshIcon.classList.remove('animate-spin');
        }
      }
    })();

    return loadingPromise;
  }

  // ‚úÖ REFACTORIZADO: Event listeners robustos
  refreshBtn?.addEventListener('click', () => {
    if (refreshIcon) {
      refreshIcon.classList.add('animate-spin');
    }
    // Clear all delegation caches on manual refresh
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith(CACHE_KEY_PREFIX)) {
        localStorage.removeItem(key);
      }
    });
    console.log('üßπ Cleared all delegation caches');

    // Reset state for fresh load
    isInitialized = false;
    loadDelegations();
  });

  retryBtn?.addEventListener('click', () => {
    // Reset state for retry
    isInitialized = false;
    loadDelegations();
  });

  // üìã Copy to Markdown functionality
  const copyMarkdownBtn = document.getElementById('copy-markdown-btn');

  copyMarkdownBtn?.addEventListener('click', async () => {
    if (!currentDelegations || currentDelegations.length === 0) {
      alert('No delegations to copy');
      return;
    }

    // Calculate total HP
    const totalHP = currentDelegations.reduce((sum: number, d: any) => sum + (d.hpAmount || 0), 0);

    // Generate markdown table
    let markdown = '## Current Delegations\n\n';
    markdown += `**Total Delegations:** ${currentDelegations.length}\n`;
    markdown += `**Total HP:** ${totalHP.toLocaleString('en-US')} HP\n\n`;
    markdown += '| Delegator | HP | Date | % Share |\n';
    markdown += '|-----------|----|----|--------|\n';

    currentDelegations.forEach((del: any) => {
      const delegationDate = del.date ? new Date(del.date) : (del.timestamp ? new Date(del.timestamp) : null);
      const dateStr = delegationDate ? delegationDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '---';
      const percentage = totalHP > 0 ? ((del.hpAmount / totalHP) * 100).toFixed(2) : '0.00';

      markdown += `| @${del.delegator} | ${del.hpAmount.toLocaleString('en-US')} HP | ${dateStr} | ${percentage}% |\n`;
    });

    markdown += '\n---\n';
    markdown += `*Generated with [Aliento Pay](${window.location.origin})*\n`;

    // Copy to clipboard
    try {
      await navigator.clipboard.writeText(markdown);

      // Show success feedback
      const originalText = copyMarkdownBtn.querySelector('span')?.textContent;
      const span = copyMarkdownBtn.querySelector('span');
      if (span) {
        span.textContent = 'Copied!';
        copyMarkdownBtn.classList.add('bg-green-500/20', 'border-green-500');

        setTimeout(() => {
          span.textContent = originalText || 'Copy MD';
          copyMarkdownBtn.classList.remove('bg-green-500/20', 'border-green-500');
        }, 2000);
      }

      console.log('‚úÖ Markdown table copied to clipboard');
    } catch (error) {
      console.error('‚ùå Failed to copy to clipboard:', error);
      alert('Failed to copy to clipboard. Please try again.');
    }
  });

  // üìÑ Pagination functionality
  function updatePagination() {
    const totalPages = Math.ceil(filteredDelegations.length / itemsPerPage);

    // Update button states
    if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

    // Generate page numbers
    if (pageNumbersEl) {
      pageNumbersEl.innerHTML = '';

      const maxPageButtons = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

      if (endPage - startPage < maxPageButtons - 1) {
        startPage = Math.max(1, endPage - maxPageButtons + 1);
      }

      // First page
      if (startPage > 1) {
        const btn = createPageButton(1);
        pageNumbersEl.appendChild(btn);
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-[var(--mutedFg)]';
          ellipsis.textContent = '...';
          pageNumbersEl.appendChild(ellipsis);
        }
      }

      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        const btn = createPageButton(i);
        pageNumbersEl.appendChild(btn);
      }

      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 text-[var(--mutedFg)]';
          ellipsis.textContent = '...';
          pageNumbersEl.appendChild(ellipsis);
        }
        const btn = createPageButton(totalPages);
        pageNumbersEl.appendChild(btn);
      }
    }

    // Get paginated data
    const startIdx = (currentPage - 1) * itemsPerPage;
    const endIdx = startIdx + itemsPerPage;
    const paginatedDelegations = filteredDelegations.slice(startIdx, endIdx);

    // Update visible count
    if (visibleCountEl) visibleCountEl.textContent = paginatedDelegations.length.toString();
    if (totalCountEl) totalCountEl.textContent = filteredDelegations.length.toString();

    // Recalculate percentages for display
    const totalHP = filteredDelegations.reduce((sum: number, d: any) => sum + (d.hpAmount || 0), 0);
    const delegationsWithPercentages = paginatedDelegations.map((delegation: any) => ({
      ...delegation,
      participationPercentage: totalHP > 0 ? (delegation.hpAmount / totalHP) * 100 : 0,
    }));

    // Re-render table
    renderDelegations(delegationsWithPercentages);
  }

  function createPageButton(pageNum: number): HTMLButtonElement {
    const btn = document.createElement('button');
    btn.textContent = pageNum.toString();
    btn.className = currentPage === pageNum
      ? 'px-3 py-1.5 rounded-lg bg-anakiwa-500 text-[var(--primary-contrast)] font-medium'
      : 'px-3 py-1.5 rounded-lg border border-[var(--border)] text-[var(--fg)] hover:bg-[var(--bg)] transition-colors';

    btn.addEventListener('click', () => {
      currentPage = pageNum;
      updatePagination();
    });

    return btn;
  }

  prevPageBtn?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
    }
  });

  nextPageBtn?.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredDelegations.length / itemsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
    }
  });

  itemsPerPageSelect?.addEventListener('change', () => {
    itemsPerPage = parseInt(itemsPerPageSelect.value);
    currentPage = 1; // Reset to first page
    updatePagination();
  });

  // üîç Search/Filter functionality
  function updateSearchResults() {
    const searchTerm = searchInput?.value.toLowerCase().trim() || '';

    if (searchTerm === '') {
      // Show all delegations
      filteredDelegations = [...currentDelegations];
      clearSearchBtn?.classList.add('hidden');
    } else {
      // Filter delegations
      filteredDelegations = currentDelegations.filter((del: any) => {
        const delegator = (del.delegator || '').toLowerCase();
        return delegator.includes(searchTerm);
      });
      clearSearchBtn?.classList.remove('hidden');
    }

    // Reset to first page on new search
    currentPage = 1;
    updatePagination();
  }

  searchInput?.addEventListener('input', () => {
    updateSearchResults();
  });

  clearSearchBtn?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    updateSearchResults();
  });

  // üîÑ Sorting functionality
  let currentSortColumn: string | null = null;
  let currentSortDirection: 'asc' | 'desc' = 'asc';

  function sortDelegations(column: string) {
    // Toggle direction if clicking the same column
    if (currentSortColumn === column) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      currentSortColumn = column;
      currentSortDirection = 'asc';
    }

    // Sort the delegations array
    currentDelegations.sort((a: any, b: any) => {
      let aValue: any;
      let bValue: any;

      switch (column) {
        case 'delegator':
          aValue = (a.delegator || '').toLowerCase();
          bValue = (b.delegator || '').toLowerCase();
          break;
        case 'hp':
          aValue = a.hpAmount || 0;
          bValue = b.hpAmount || 0;
          break;
        case 'date':
          aValue = a.date ? new Date(a.date).getTime() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
          bValue = b.date ? new Date(b.date).getTime() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
          break;
        default:
          return 0;
      }

      if (aValue < bValue) return currentSortDirection === 'asc' ? -1 : 1;
      if (aValue > bValue) return currentSortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    // Update filtered delegations after sorting
    filteredDelegations = [...currentDelegations];

    // Update sort icon visibility
    document.querySelectorAll('[data-sort]').forEach(th => {
      const icon = th.querySelector('.sort-icon');
      if (icon) {
        if (th.getAttribute('data-sort') === column) {
          icon.classList.remove('opacity-0', 'group-hover:opacity-50');
          icon.classList.add('opacity-100');
          // Rotate icon for descending
          if (currentSortDirection === 'desc') {
            icon.classList.add('rotate-180');
          } else {
            icon.classList.remove('rotate-180');
          }
        } else {
          icon.classList.add('opacity-0', 'group-hover:opacity-50');
          icon.classList.remove('opacity-100', 'rotate-180');
        }
      }
    });

    // Reset to first page and re-render with pagination
    currentPage = 1;
    updatePagination();
  }

  // Add click handlers to sortable headers
  document.querySelectorAll('[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const sortColumn = th.getAttribute('data-sort');
      if (sortColumn) {
        sortDelegations(sortColumn);
      }
    });
  });

  // ‚úÖ REFACTORIZADO: Inicializaci√≥n robusta y √∫nica
  async function initializeTableDelegations() {
    // üõ°Ô∏è Solo ejecutar una vez
    if (isInitialized) {
      console.log('‚ö†Ô∏è [DELEGATIONS] Tabla de delegaciones ya inicializada, saltando...');
      return;
    }

    console.log('üéØ [DELEGATIONS] Table Delegations component initialized');
    isInitialized = true;

    // Fetch HIVE price in parallel with delegations
    fetchHivePrice().then(price => {
      hivePrice = price;
      priceLoading = false;

      // Update price badge
      const priceBadge = document.getElementById('hive-price-badge');
      if (priceBadge) {
        priceBadge.textContent = `$${price.toFixed(4)}`;
      }

      // Re-render table to show USD values
      if (filteredDelegations.length > 0) {
        currentPage = 1;
        updatePagination();
      }
    });

    loadDelegations();
  }

  // üöÄ Setup √∫nico de inicializaci√≥n
  function setupTableInitialization() {
    console.log('üîß [DELEGATIONS] Configurando inicializaci√≥n de tabla de delegaciones...');

    // üì± Funci√≥n unificada de inicializaci√≥n
    function handleInitialization(source: string) {
      console.log(`üì° [DELEGATIONS] Tabla: ${source} event`);
      initializeTableDelegations();
    }

    // üéØ Event listeners √∫nicos con { once: true }
    document.addEventListener('DOMContentLoaded', () => handleInitialization('DOMContentLoaded'), {
      once: true,
    });
    document.addEventListener('astro:page-load', () => handleInitialization('Astro page load'), {
      once: true,
    });
    document.addEventListener('aliento:page-ready', () => handleInitialization('P√°gina lista'), {
      once: true,
    });

    // ‚ö° Inicializaci√≥n inmediata si est√° listo
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      console.log('‚ö° Tabla: P√°gina ya lista, inicializando inmediatamente');
      setTimeout(() => handleInitialization('Inmediata'), 50);
    }
  }

  // üöÄ Ejecutar configuraci√≥n
  setupTableInitialization();
</script>
