---
/**
 * ðŸ“ MEMO SETTINGS COMPONENT
 *
 * Simplified memo customization for payment templates
 * Saves to localStorage and passes to calculate/payments pages
 */

import { getTranslation, getCurrentLocale } from '../../i18n';

const currentLocale = getCurrentLocale(Astro);
const t = (key: string) => getTranslation(currentLocale, key);
---

<div class="memo-settings bg-[var(--bgElevated)] border border-[var(--border)] rounded-xl p-6">
  <div class="flex items-start gap-4">
    <div class="w-10 h-10 bg-anakiwa-500/10 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg class="w-5 h-5 text-anakiwa-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
        ></path>
      </svg>
    </div>

    <div class="flex-1">
      <h3 class="text-lg font-bold text-[var(--fg)] mb-2">{t('memo.title')}</h3>
      <p class="text-sm text-[var(--mutedFg)] mb-4">
        {t('memo.description')}
        <span class="text-anakiwa-300 font-mono text-xs">{'{period}'}</span>,
        <span class="text-anakiwa-300 font-mono text-xs">{'{username}'}</span>,
        <span class="text-anakiwa-300 font-mono text-xs">{'{amount}'}</span>,
        <span class="text-anakiwa-300 font-mono text-xs">{'{date}'}</span>
      </p>

      <div class="space-y-4">
        <!-- Memo Template Input with Save Button -->
        <div class="flex gap-2">
          <input
            type="text"
            id="dashboard-memo-template"
            class="flex-1 px-4 py-3 bg-[var(--bg)] border border-[var(--border)] rounded-lg text-[var(--fg)] placeholder-[var(--mutedFg)] focus:outline-none focus:ring-2 focus:ring-anakiwa-500 focus:border-transparent text-sm"
            placeholder={t('memo.templatePlaceholder')}
          />
          <button
            id="save-memo-template"
            class="px-6 py-3 bg-anakiwa-500 hover:bg-anakiwa-600 text-[var(--primary-contrast)] font-medium rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg text-sm flex items-center gap-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
              ></path>
            </svg>
            {t('common.save')}
          </button>
        </div>

        <!-- Quick Templates (Simplified) -->
        <div>
          <label class="block text-sm font-medium text-[var(--mutedFg)] mb-2">{t('memo.quickTemplates')}</label>
          <div class="grid grid-cols-2 gap-2">
            <button
              class="memo-quick-template px-3 py-2 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-all"
              data-template={t('memo.defaults.basic')}
            >
              {t('memo.templates.default')}
            </button>
            <button
              class="memo-quick-template px-3 py-2 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-all"
              data-template={t('memo.defaults.emoji')}
            >
              {t('memo.templates.withEmoji')}
            </button>
            <button
              class="memo-quick-template px-3 py-2 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-all"
              data-template={t('memo.defaults.detailed')}
            >
              {t('memo.templates.detailed')}
            </button>
            <button
              class="memo-quick-template px-3 py-2 bg-[var(--bg)] hover:bg-anakiwa-900/20 border border-[var(--border)] hover:border-anakiwa-500/50 text-[var(--fg)] text-xs rounded-lg transition-all"
              data-template={t('memo.defaults.simple')}
            >
              {t('memo.templates.simple')}
            </button>
          </div>
        </div>

        <!-- Preview -->
        <div class="bg-anakiwa-900/10 rounded-lg p-3 border border-anakiwa-500/20">
          <div class="text-xs text-anakiwa-300 mb-1">{t('memo.preview')}</div>
          <div class="text-sm text-[var(--fg)] font-mono" id="dashboard-memo-preview">
            {t('memo.defaults.basic').replace('{period}', '30d')}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  (function () {
    'use strict';

    const MEMO_TEMPLATE_KEY = 'user_memo_template';
    const DEFAULT_TEMPLATE = 'Curation payment {period} - Aliento.pay';

    function initMemoSettings() {
      const templateInput = document.getElementById('dashboard-memo-template');
      const saveButton = document.getElementById('save-memo-template');
      const previewDiv = document.getElementById('dashboard-memo-preview');
      const quickTemplateButtons = document.querySelectorAll('.memo-quick-template');

      if (!templateInput) return;

      // Load saved template or use default
      const savedTemplate = localStorage.getItem(MEMO_TEMPLATE_KEY) || DEFAULT_TEMPLATE;
      templateInput.value = savedTemplate;
      updatePreview(savedTemplate);

      // Save template
      saveButton?.addEventListener('click', () => {
        const template = templateInput.value.trim();
        if (template) {
          localStorage.setItem(MEMO_TEMPLATE_KEY, template);
          console.log('âœ… Memo template saved:', template);
          showNotification('âœ… Memo template saved!', 'success');
        }
      });

      // Live preview
      templateInput.addEventListener('input', (e) => {
        updatePreview(e.target.value);
      });

      // Quick templates - automatically save when clicked
      quickTemplateButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const template = btn.getAttribute('data-template');
          if (template) {
            templateInput.value = template;
            updatePreview(template);
            localStorage.setItem(MEMO_TEMPLATE_KEY, template);
            showNotification('âœ… Template applied and saved!', 'success');
          }
        });
      });
    }

    function updatePreview(template) {
      const previewDiv = document.getElementById('dashboard-memo-preview');
      if (!previewDiv) return;

      // Replace variables with sample data
      const preview = template
        .replace(/{period}/g, '30d')
        .replace(/{username}/g, 'sampleuser')
        .replace(/{amount}/g, '5.000')
        .replace(/{date}/g, new Date().toLocaleDateString());

      previewDiv.textContent = preview;
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 z-50 max-w-sm px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-anakiwa-500' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      } text-[var(--primary-contrast)] font-medium`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 2500);
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMemoSettings);
    } else {
      initMemoSettings();
    }

    // Re-initialize for Astro view transitions
    document.addEventListener('astro:page-load', initMemoSettings);
  })();
</script>
