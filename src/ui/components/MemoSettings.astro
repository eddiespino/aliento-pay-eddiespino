---
/**
 * ðŸ“ MEMO SETTINGS COMPONENT
 *
 * Allows users to customize payment memo template from the dashboard
 * Saves to localStorage and passes to calculate/payments pages
 */

import { getTranslation, getCurrentLocale } from '../../i18n';

const currentLocale = getCurrentLocale(Astro);
const t = (key: string) => getTranslation(currentLocale, key);
---

<div class="memo-settings bg-gradient-to-r from-purple-900/30 to-blue-900/30 backdrop-blur-sm border border-purple-500/30 rounded-xl p-6">
  <div class="flex items-start gap-3">
    <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
        ></path>
      </svg>
    </div>

    <div class="flex-1">
      <h3 class="text-lg font-bold text-white mb-2">{t('memo.title')}</h3>
      <p class="text-sm text-gray-300 mb-4">
        {t('memo.description')}
        <span class="text-purple-300 font-mono text-xs">{'{period}'}</span>,
        <span class="text-purple-300 font-mono text-xs">{'{username}'}</span>,
        <span class="text-purple-300 font-mono text-xs">{'{amount}'}</span>,
        <span class="text-purple-300 font-mono text-xs">{'{date}'}</span>
      </p>

      <div class="space-y-3">
        <!-- Memo Template Input -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">{t('memo.templateLabel')}</label>
          <div class="flex gap-2">
            <input
              type="text"
              id="dashboard-memo-template"
              class="flex-1 px-4 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
              placeholder={t('memo.templatePlaceholder')}
            />
            <button
              id="save-memo-template"
              class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg text-sm flex items-center gap-2"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                ></path>
              </svg>
              {t('common.save')}
            </button>
          </div>
        </div>

        <!-- Quick Templates -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">{t('memo.quickTemplates')}</label>
          <div class="flex flex-wrap gap-2">
            <button
              class="memo-quick-template px-3 py-1.5 bg-gray-700/50 hover:bg-gray-600/50 text-gray-200 text-xs rounded-lg transition-colors"
              data-template={t('memo.defaults.basic')}
            >
              {t('memo.templates.default')}
            </button>
            <button
              class="memo-quick-template px-3 py-1.5 bg-gray-700/50 hover:bg-gray-600/50 text-gray-200 text-xs rounded-lg transition-colors"
              data-template={t('memo.defaults.emoji')}
            >
              {t('memo.templates.withEmoji')}
            </button>
            <button
              class="memo-quick-template px-3 py-1.5 bg-gray-700/50 hover:bg-gray-600/50 text-gray-200 text-xs rounded-lg transition-colors"
              data-template={t('memo.defaults.detailed')}
            >
              {t('memo.templates.detailed')}
            </button>
            <button
              class="memo-quick-template px-3 py-1.5 bg-gray-700/50 hover:bg-gray-600/50 text-gray-200 text-xs rounded-lg transition-colors"
              data-template={t('memo.defaults.simple')}
            >
              {t('memo.templates.simple')}
            </button>
          </div>
        </div>

        <!-- Preview -->
        <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-600/30">
          <div class="text-xs text-gray-400 mb-1">{t('memo.preview')}</div>
          <div class="text-sm text-white font-mono" id="dashboard-memo-preview">
            {t('memo.defaults.basic').replace('{period}', '30d')}
          </div>
        </div>

        <!-- Save as Default Toggle -->
        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            id="save-as-default"
            class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-2"
            checked
          />
          <label for="save-as-default" class="text-sm text-gray-300 cursor-pointer">
            {t('memo.saveAsDefault')}
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  (function () {
    'use strict';

    const MEMO_TEMPLATE_KEY = 'user_memo_template';
    const DEFAULT_TEMPLATE = 'Curation payment {period} - Aliento.pay';

    function initMemoSettings() {
      const templateInput = document.getElementById('dashboard-memo-template');
      const saveButton = document.getElementById('save-memo-template');
      const previewDiv = document.getElementById('dashboard-memo-preview');
      const saveAsDefaultCheckbox = document.getElementById('save-as-default');
      const quickTemplateButtons = document.querySelectorAll('.memo-quick-template');

      if (!templateInput) return;

      // Load saved template or use default
      const savedTemplate = localStorage.getItem(MEMO_TEMPLATE_KEY) || DEFAULT_TEMPLATE;
      templateInput.value = savedTemplate;
      updatePreview(savedTemplate);

      // Save template
      saveButton?.addEventListener('click', () => {
        const template = templateInput.value.trim();
        if (template) {
          if (saveAsDefaultCheckbox?.checked) {
            localStorage.setItem(MEMO_TEMPLATE_KEY, template);
            console.log('âœ… Memo template saved as default:', template);
          }

          showNotification('Memo template saved!', 'success');
        }
      });

      // Live preview
      templateInput.addEventListener('input', (e) => {
        updatePreview(e.target.value);
      });

      // Quick templates
      quickTemplateButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const template = btn.getAttribute('data-template');
          if (template) {
            templateInput.value = template;
            updatePreview(template);

            if (saveAsDefaultCheckbox?.checked) {
              localStorage.setItem(MEMO_TEMPLATE_KEY, template);
            }

            showNotification('Template applied!', 'success');
          }
        });
      });
    }

    function updatePreview(template) {
      const previewDiv = document.getElementById('dashboard-memo-preview');
      if (!previewDiv) return;

      // Replace variables with sample data
      const preview = template
        .replace(/{period}/g, '30d')
        .replace(/{username}/g, 'sampleuser')
        .replace(/{amount}/g, '5.000')
        .replace(/{date}/g, new Date().toLocaleDateString());

      previewDiv.textContent = preview;
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 max-w-sm px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      } text-white`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMemoSettings);
    } else {
      initMemoSettings();
    }

    // Re-initialize for Astro view transitions
    document.addEventListener('astro:page-load', initMemoSettings);
  })();
</script>
