---
import type { Payment } from '@/domain/models/Payment';
import { getCurrentLocale, getTranslation } from '../../i18n';

export interface Props {
  payments: Payment[];
}

const { payments } = Astro.props;
const currentLocale = getCurrentLocale(Astro);
const t = (key: string) => getTranslation(currentLocale, key);
---

<div class="bg-[var(--bgElevated)] backdrop-blur-sm border border-[var(--border)] rounded-xl p-6">
  <div class="flex items-center justify-between mb-6">
    <h3 class="text-xl font-bold text-[var(--fg)] flex items-center gap-2">
      <svg class="w-5 h-5 text-anakiwa-400" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
      </svg>
      {t('payments.paymentList')}
    </h3>
    <div class="text-sm text-[var(--mutedFg)]">
      {payments.length} {t('payments.transfers')}
    </div>
  </div>

  <div class="max-h-96 overflow-y-auto space-y-2">
    {payments.map((payment, index) => (
      <div class="bg-[var(--bg)] rounded-lg p-4 border border-[var(--border)] hover:bg-anakiwa-900/10 transition-colors">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="relative w-8 h-8" data-username={payment.to}>
              <!-- Fallback avatar with number -->
              <div class="avatar-fallback w-8 h-8 bg-anakiwa-500/20 rounded-full flex items-center justify-center">
                <span class="text-anakiwa-400 text-sm font-bold">{index + 1}</span>
              </div>
              <!-- Container for real avatar image -->
              <div class="avatar-img absolute inset-0"></div>
            </div>
            <div>
              <div class="font-medium text-[var(--fg)]">@{payment.to}</div>
              <div class="text-xs text-[var(--mutedFg)] truncate max-w-xs">
                {payment.memo}
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-anakiwa-400">{payment.amount} HIVE</div>
            <div class="text-xs text-[var(--mutedFg)] capitalize">
              {payment.status ? t(`payments.status.${payment.status}`) : t('payments.status.pending')}
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>

  {payments.length === 0 && (
    <div class="text-center py-8">
      <div class="w-16 h-16 bg-anakiwa-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-anakiwa-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
      </div>
      <h4 class="text-lg font-medium text-[var(--fg)] mb-2">{t('payments.noPaymentsTitle')}</h4>
      <p class="text-[var(--mutedFg)] text-sm">{t('payments.noPaymentsDescription')}</p>
    </div>
  )}
</div>

<script>

  // ðŸ§ª FunciÃ³n de test para verificar URLs de avatar
  function testPaymentAvatarUrls() {
    const testUsernames = ['@aliento', 'aliento', '@hispapro', 'hispapro'];
    console.log('ðŸ§ª PaymentsList: Testing avatar URLs:');
    testUsernames.forEach(username => {
      const normalized = username.replace('@', '').trim().toLowerCase();
      const avatarUrl = `https://images.hive.blog/u/${normalized}/avatar`;
      console.log(`  ${username} -> ${avatarUrl}`);
    });
  }

  // âœ… Carga directa de avatares sin cache (SIMPLIFICADO)
  function loadPaymentAvatarsDirectSimple() {
    console.log('ðŸ–¼ï¸ PaymentsList: Iniciando carga directa de avatares...');
    
    // Ejecutar test de URLs
    testPaymentAvatarUrls();
    
    // Verificar que estamos en una pÃ¡gina con PaymentsList
    if (!isOnPaymentsPage()) {
      console.log('â„¹ï¸ PaymentsList: No estamos en una pÃ¡gina con pagos');
      return;
    }
    
    // Obtener todos los contenedores de avatar
    const avatarContainers = document.querySelectorAll('[data-username]');
    
    console.log(`ðŸ” PaymentsList: Encontrados ${avatarContainers.length} contenedores de avatar`);
    
    if (avatarContainers.length === 0) {
      console.log('â„¹ï¸ PaymentsList: No se encontraron avatares para cargar - reintentando...');
      setTimeout(loadPaymentAvatarsDirectSimple, 1000);
      return;
    }
    
    // Procesar cada contenedor
    avatarContainers.forEach((container, index) => {
      const username = container.getAttribute('data-username');
      if (!username) return;
      
      const avatarContainer = container.querySelector('.avatar-img');
      const fallback = container.querySelector('.avatar-fallback');
      
      if (!avatarContainer || !fallback) {
        console.warn(`âš ï¸ PaymentsList: No se encontraron contenedores para @${username}`);
        return;
      }
      
      // Verificar si ya tiene avatar cargado
      if (avatarContainer.querySelector('img')) {
        console.log(`âœ… PaymentsList: Avatar ya cargado para @${username}`);
        return;
      }
      
      console.log(`ðŸ”„ PaymentsList: Cargando avatar para @${username}...`);
      
      // Crear imagen directamente (remover @ si existe)
      const normalized = username.replace('@', '').trim().toLowerCase();
      const avatarUrl = `https://images.hive.blog/u/${normalized}/avatar`;
      
      console.log(`ðŸ”— PaymentsList: URL de avatar para @${username}: ${avatarUrl}`);
      
      const img = document.createElement('img');
      img.src = avatarUrl;
      img.alt = `@${username}`;
      img.className = 'w-8 h-8 rounded-full object-cover';
      
      // Manejar carga exitosa
      img.onload = function() {
        avatarContainer.appendChild(img);
        // Para PaymentsList, hacemos overlay en lugar de ocultar fallback
        fallback.style.opacity = '0.3';
        console.log(`âœ… PaymentsList: Avatar cargado exitosamente para @${username}`);
      };
      
      // Manejar error de carga
      img.onerror = function() {
        console.log(`âš ï¸ PaymentsList: Error cargando avatar para @${username}, manteniendo fallback`);
      };
    });
    
    console.log(`âœ… PaymentsList: Proceso de carga de avatares iniciado para ${avatarContainers.length} usuarios`);
  }

  // FunciÃ³n para verificar si estamos en una pÃ¡gina con PaymentsList
  function isOnPaymentsPage() {
    return window.location.pathname.includes('/calculate') || 
           window.location.pathname.includes('/payments');
  }


  // Inicializar avatares con mÃ©todo directo y simple
  
  // 1. Inmediatamente despuÃ©s del DOM
  setTimeout(loadPaymentAvatarsDirectSimple, 100);
  
  // 2. Cuando el DOM estÃ© listo
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(loadPaymentAvatarsDirectSimple, 200);
  });
  
  // 3. DespuÃ©s de que todo estÃ© cargado
  window.addEventListener('load', () => {
    setTimeout(loadPaymentAvatarsDirectSimple, 400);
  });
  
  // 4. Reintento despuÃ©s de 2 segundos
  setTimeout(loadPaymentAvatarsDirectSimple, 2000);
  
  // 5. Ãšltimo intento despuÃ©s de 5 segundos
  setTimeout(loadPaymentAvatarsDirectSimple, 5000);
  
  // 6. Escuchar eventos especÃ­ficos de la aplicaciÃ³n
  window.addEventListener('payments:updated', () => {
    setTimeout(loadPaymentAvatarsDirectSimple, 100);
  });
  
  // 7. Escuchar cambios de navegaciÃ³n (para SPAs)
  window.addEventListener('astro:page-load', () => {
    setTimeout(loadPaymentAvatarsDirectSimple, 200);
  });
  
  // 8. Observer para detectar cuando aparezcan elementos con data-username
  const paymentObserver = new MutationObserver((mutations) => {
    let hasNewPayments = false;
    mutations.forEach((mutation) => {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE) {
            const element = node as Element;
            if (element.getAttribute && element.getAttribute('data-username')) {
              hasNewPayments = true;
            }
            // TambiÃ©n verificar descendientes
            const descendantsWithUsername = element.querySelectorAll('[data-username]');
            if (descendantsWithUsername.length > 0) {
              hasNewPayments = true;
            }
          }
        });
      }
    });
    
    if (hasNewPayments) {
      console.log('ðŸ”„ PaymentsList: Detectados nuevos elementos de pago, cargando avatares...');
      setTimeout(loadPaymentAvatarsDirectSimple, 100);
    }
  });
  
  // Observar cambios en el documento
  paymentObserver.observe(document.body, {
    childList: true,
    subtree: true
  });
</script>
