---
import BrandNav from '../base/BrandNav.astro';

export interface Props {
  username?: string;
  showStats?: boolean;
}

const { username, showStats = true } = Astro.props;
---

<!-- Brand Navigation with transparent background -->
<BrandNav user={username} />

<!-- Spacer para compensar el nav fijo -->
<div class="h-14"></div>

<script>
  import { getHiveAvatarUrl } from '../../domain/services/HiveAccountService';

  // ‚úÖ REFACTORIZADO: Estado global para evitar m√∫ltiples inicializaciones
  let headerInitialized: boolean = false;
  let headerInitializationPromise: Promise<void> | null = null;
  let currentAbortController: AbortController | null = null;

  // Funci√≥n de inicializaci√≥n del header (robusta y √∫nica)
  async function initializeHeader() {
    // üõ°Ô∏è Evitar m√∫ltiples inicializaciones
    if (headerInitialized) {
      console.log('‚ö†Ô∏è Header ya inicializado, saltando...');
      return;
    }

    // üîÑ Si ya hay una inicializaci√≥n en progreso, esperar a que termine
    if (headerInitializationPromise) {
      console.log('‚è≥ Esperando inicializaci√≥n en progreso...');
      return headerInitializationPromise;
    }

    // üö´ Cancelar cualquier request HTTP previo
    if (currentAbortController) {
      currentAbortController.abort();
      console.log('üö´ Cancelando requests HTTP previos');
    }

    // üÜï Crear nuevo AbortController para esta inicializaci√≥n
    currentAbortController = new AbortController();

    console.log('üîÑ Inicializando header (versi√≥n robusta)...');

    // üìù Marcar como inicializaci√≥n en progreso
    headerInitializationPromise = (async () => {
      try {
        // Importar dependencias de la arquitectura hexagonal
        const { container } = await import('../../application/Container');
        const authUseCase = container.getAuthenticationUseCase();
        const delegationsUseCase = container.getDelegationsUseCase();

        // Elementos del DOM
        const userGreeting = document.getElementById('user-greeting');
        const userAvatar = document.getElementById('user-avatar-img') as HTMLImageElement | null;
        const logoutBtn = document.getElementById('logout-btn');

        // Verificar autenticaci√≥n
        const username = authUseCase.getCurrentUser();
        if (!username) {
          console.log('üìù No hay usuario autenticado en header');
          return; // No hacer nada si no est√° autenticado
        }

        // Configurar informaci√≥n de usuario
        if (userGreeting) userGreeting.textContent = `@${username}`;
        if (userAvatar) {
          // Actualizar avatar (ya es un elemento <img>)
          const avatarUrl = getHiveAvatarUrl(username);
          userAvatar.src = avatarUrl;
          userAvatar.alt = `@${username}`;
        }

        // Evento de logout (remover listeners existentes)
        if (logoutBtn) {
          logoutBtn.replaceWith(logoutBtn.cloneNode(true));
          const newLogoutBtn = document.getElementById('logout-btn');
          if (newLogoutBtn) {
            newLogoutBtn.onclick = () => {
              authUseCase.logout();
              window.location.href = '/';
            };
          }
        }

        // Cargar estad√≠sticas si est√°n habilitadas

        // ‚úÖ Marcar como completamente inicializado
        headerInitialized = true;
        console.log('‚úÖ Header inicializado correctamente');
      } catch (error) {
        if (error instanceof Error && error.name === 'AbortError') {
          console.log('üö´ Inicializaci√≥n cancelada');
          return;
        }
        console.warn('Error inicializando header:', error);
      } finally {
        // Limpiar el promise de inicializaci√≥n
        headerInitializationPromise = null;
      }
    })();

    return headerInitializationPromise;
  }

  // ‚úÖ REFACTORIZADO: Funci√≥n para inicializar con retry (robusta)
  function initializeHeaderWithRetry(maxRetries = 3, delay = 100) {
    // üõ°Ô∏è Evitar m√∫ltiples retries si ya est√° inicializado
    if (headerInitialized) {
      console.log('‚ö†Ô∏è Header ya inicializado, saltando retry...');
      return;
    }

    let retries = 0;

    function tryInitialize() {
      // Verificar que existan los elementos necesarios
      const userGreeting = document.getElementById('user-greeting');
      const userAvatar = document.getElementById('user-avatar-img');
      const logoutBtn = document.getElementById('logout-btn');

      // Verificar que al menos el elemento principal exista
      if (userGreeting || userAvatar || logoutBtn) {
        console.log('‚úÖ Elementos del header encontrados, inicializando...');
        initializeHeader();
        return;
      }

      // Tambi√©n verificar si hay un usuario autenticado
      const authUser = localStorage.getItem('authenticated_user');
      if (!authUser) {
        console.log('üìù No hay usuario autenticado, no se necesita inicializar header');
        return;
      }

      if (retries < maxRetries) {
        retries++;
        console.log(`üîÑ Reintentando inicializaci√≥n del header (${retries}/${maxRetries})`);
        setTimeout(tryInitialize, delay);
      } else {
        console.warn('‚ö†Ô∏è No se pudo inicializar el header - elementos no encontrados');
        console.log('üîç Elementos buscados:', {
          userGreeting: !!document.getElementById('user-greeting'),
          userAvatar: !!document.getElementById('user-avatar-img'),
          logoutBtn: !!document.getElementById('logout-btn'),
          authUser: !!authUser,
        });
      }
    }

    tryInitialize();
  }

  // ‚úÖ REFACTORIZADO: √önico punto de entrada robusto
  function setupHeaderInitialization() {
    // üõ°Ô∏è Solo ejecutar una vez
    if (headerInitialized) {
      console.log('‚ö†Ô∏è Header ya configurado, saltando...');
      return;
    }

    console.log('üîß Configurando inicializaci√≥n del header...');

    // üì± Funci√≥n unificada de inicializaci√≥n
    function handleInitialization(source: string) {
      console.log(`üì° Header: ${source} event`);
      initializeHeaderWithRetry();
    }

    // üéØ Event listeners que permiten re-inicializaci√≥n en navegaci√≥n SPA
    document.addEventListener('DOMContentLoaded', () => handleInitialization('DOMContentLoaded'));
    document.addEventListener('astro:page-load', () => {
      // Resetear estado para permitir re-inicializaci√≥n
      headerInitialized = false;
      headerInitializationPromise = null;
      handleInitialization('Astro page load');
    });
    document.addEventListener('aliento:page-ready', () => handleInitialization('P√°gina lista'));

    // ‚ö° Inicializaci√≥n inmediata si est√° listo
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      console.log('‚ö° Header: P√°gina ya lista, inicializando inmediatamente');
      setTimeout(() => handleInitialization('Inmediata'), 50);
    }
  }

  // üöÄ Ejecutar configuraci√≥n
  setupHeaderInitialization();
</script>
